{% extends 'webapp/base.html' %}
{% load static %}
{% block title %}Global Exchange - Inicio{% endblock %}

{% block content %}

<div class="main-home-row" style="display: flex; gap: 32px; align-items: flex-start; justify-content: flex-start; background: #000; min-height: 480px; padding: 32px 0;">
    
    <!-- COLUMNA IZQUIERDA: simulador arriba + caja blanca debajo -->
    <div style="flex: 1; min-width: 450px; max-width: 550px; margin-left: 32px; margin-right: 32px; display: flex; flex-direction: column; gap: 16px;">

        <!-- === SIMULADOR DE CONVERSI√ìN === -->
        <section id="simu-conversion" style="
            background:#1a1a1a; color:#fff; border-radius:20px; 
            padding:16px; border:1px solid rgba(255,255,255,0.06);
            box-shadow:0 8px 24px rgba(0,0,0,0.25);">

            <div style="display:flex; align-items:center; justify-content:space-between; gap:12px; margin-bottom:10px;">
                <h2 style="margin:0; font-size:18px; font-weight:800;">Simulador de Conversi√≥n</h2>
                <span style="background:#2a2a2a; padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px;">‚Ç≤ ‚Ä¢ $ ‚Ä¢ ‚Ç¨</span>
            </div>

            <div style="margin-bottom:14px;">
                <label for="simu-amount" style="font-weight:600; display:block; margin-bottom:6px;">Monto</label>
                <div style="background:#0f0f0f; border:1px solid rgba(255,255,255,0.12); border-radius:10px; padding:8px 12px;">
                    <input id="simu-amount" type="number" step="0.01" min="0" placeholder="0,00" style="
                    width:100%; border:none; outline:none; background:transparent; color:#fff; font-size:16px;">
                </div>
            </div>


            <div style="display:grid; grid-template-columns:1fr 56px 1fr; gap:10px;">
                <div>
                <label for="simu-from" style="font-weight:600;">Desde</label>
                <select id="simu-from" style="
                    width:100%; padding:10px 12px; color:#fff; background:#0f0f0f;
                    border:1px solid rgba(255,255,255,0.12); border-radius:10px;">
                    <option value="PYG">PYG (‚Ç≤)</option>
                    <option value="USD" selected>USD ($)</option>
                    <option value="EUR">EUR (‚Ç¨)</option>
                </select>
                </div>

                <button id="simu-swap" type="button" title="Intercambiar" style="
                align-self:end; height:40px; border-radius:10px; border:none; cursor:pointer;
                background:#2a2a2a; color:#fff; font-weight:800;">‚áÑ</button>

                <div>
                <label for="simu-to" style="font-weight:600;">Hacia</label>
                <select id="simu-to" style="
                    width:100%; padding:10px 12px; color:#fff; background:#0f0f0f;
                    border:1px solid rgba(255,255,255,0.12); border-radius:10px;">
                    <option value="PYG" selected>PYG (‚Ç≤)</option>
                    <option value="USD">USD ($)</option>
                    <option value="EUR">EUR (‚Ç¨)</option>
                </select>
                </div>
            </div>

            <div style="display:flex; gap:8px; margin:10px 0 6px;">
                <button id="simu-calc" type="button" style="
                padding:10px 12px; border-radius:10px; border:none; cursor:pointer; font-weight:800;
                background:linear-gradient(90deg,#4b2bb7,#152a73); color:#fff;">Calcular</button>
                <button id="simu-copy" type="button" style="
                padding:10px 12px; border-radius:10px; border:none; cursor:pointer; font-weight:800;
                background:#2a2a2a; color:#fff;">Copiar</button>
                <button id="simu-clear" type="button" style="
                padding:10px 12px; border-radius:10px; border:none; cursor:pointer; font-weight:800;
                background:#2a2a2a; color:#fff;">Limpiar</button>
            </div>

            <div>
                <p id="simu-result-main" style="margin:0; font-size:22px; font-weight:900;">‚Äî</p>
                <p id="simu-result-detail" style="margin:6px 0 0; color:#bdbdbd;">Ingres√° un monto para calcular</p>
                <p style="margin:6px 0 0; color:#9c9c9c; font-size:12px;">Cotizaciones de referencia. Solo PYG, USD y EUR.</p>
            </div>
        </section>
        <!-- === /SIMULADOR === -->
    
        <div class="exchange-rates-box" style="flex:1; background:#eaeaea; border-radius:32px; padding:30px 20px; box-shadow:0 2px 8px rgba(0,0,0,0.08);">

            <div style="text-align: center; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 10px;">
                    <span style="font-size: 1.6em; font-weight: bold; background: #bdbdbd; border-radius: 20px; padding: 10px 24px; display: inline-block;">
                        {% if last_update %}
                            √öltima actualizaci√≥n: {{ last_update|date:"d/m/Y H:i" }}
                        {% else %}
                            √öltima actualizaci√≥n: No disponible
                        {% endif %}
                    </span>
                    <button id="refresh-btn" onclick="refreshRates()" style="background: #4CAF50; color: white; border: none; border-radius: 50%; width: 45px; height: 45px; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease;" title="Actualizar cotizaciones">
                        üîÑ
                    </button>
                </div>
                <div style="font-size: 0.9em; color: #666; font-style: italic;">
                    Cotizaciones sujetas a variaciones
                </div>
            </div>

            <table style="width: 100%; border-collapse: separate; border-spacing: 0; background: #eaeaea;">
                <thead>
                    <tr style="background: #bdbdbd;">
                        <th style="padding: 12px 10px; text-align: left; border-radius: 12px 0 0 0; font-size: 1.2em;">Moneda</th>
                        <th style="padding: 12px 20px; text-align: right; font-size: 1.2em;">Compra</th>
                        <th style="padding: 12px 10px; text-align: right; border-radius: 0 12px 0 0; font-size: 1.2em;">Venta</th>
                    </tr>
                </thead>
                <tbody>
                    {% for currency in currencies %}
                    <tr>
                        <td style="padding: 10px 8px; display: flex; align-items: center; gap: 12px; font-size: 1.1em;">
                            {% if currency.flag_image %}
                                <img src="{{ currency.flag_image.url }}" alt="{{ currency.name }}" style="width: 40px; height: 26px; object-fit: cover; border-radius: 4px;">
                            {% endif %}
                            <span>{{ currency.name }}</span>
                        </td>
                        <td style="padding: 10px 20px; text-align: right; font-size: 1.1em;">{{ currency.totalCompra|floatformat:currency.decimales_monto }}</td>
                        <td style="padding: 10px 8px; text-align: right; font-size: 1.1em;">{{ currency.totalVenta|floatformat:currency.decimales_monto }}</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <div class="hero-content" style="flex:1; min-width:340px; color:#fff; text-align:left;">        

        <h1 style="font-size: 2em;">Bienvenido a Global Exchange</h1>
        <p class="hero-subtitle" style="font-size: 1.1em;">Tu plataforma confiable para el intercambio de divisas y servicios financieros globales</p>
        <div class="hero-features">
            <div class="feature-item"><div class="feature-icon">üí±</div><h3 style="font-size: 1.2em;">Intercambio Seguro</h3><p>Transacciones seguras y confiables</p></div>
            <div class="feature-item"><div class="feature-icon">üåç</div><h3 style="font-size: 1.2em;">Global</h3><p>Acceso mundial a servicios financieros</p></div>
            <div class="feature-item"><div class="feature-icon">‚ö°</div><h3 style="font-size: 1.2em;">R√°pido</h3><p>Procesamiento instant√°neo</p></div>
        </div>
        <div class="homepage-links">
            {% if not user.is_authenticated %}
                <a href="{% url 'login' %}" class="home-btn">Iniciar Sesi√≥n</a>
                <a href="{% url 'register' %}" class="home-btn btn-primary">Registrarse</a>
            {% endif %}
            {% if can_access_gestiones %}
                <a href="{% url 'landing' %}" class="home-btn btn-primary">Ir a Gestiones</a>
            {% endif %}
        </div>
    </div>
</div>

<div class="homepage-services">
    <div class="container">
        <h2>Nuestros Servicios</h2>
        
        <!-- Service 1: Consulta de Tasas de Cambio -->
        <div class="service-row">
            <div class="service-visual">
                <div class="service-image">
                    <img src="{% static 'webapp/pantalla_principal_servicios/1Consulta.png' %}" alt="Consulta de Tasas de Cambio" class="service-visual-img">
                </div>
            </div>
            <div class="service-content">
                <div class="service-icon">
                    <img src="{% static 'webapp/pantalla_principal_servicios/1ConsultaIcono.png' %}" alt="Icono Consulta" class="service-icon-img">
                </div>
                <h3>Consulta de Tasas de Cambio</h3>
                <p>Revisa el valor actualizado de diferentes monedas en tiempo real</p>
            </div>
        </div>

        <!-- Service 2: Compra y Venta de Divisas -->
        <div class="service-row">
            <div class="service-visual">
                <div class="service-image">
                    <img src="{% static 'webapp/pantalla_principal_servicios/2CompraVenta.png' %}" alt="Compra y Venta de Divisas" class="service-visual-img">
                </div>
            </div>
            <div class="service-content">
                <div class="service-icon">
                    <img src="{% static 'webapp/pantalla_principal_servicios/2CompraVentaIcono.png' %}" alt="Icono Compra Venta" class="service-icon-img">
                </div>
                <h3>Compra y Venta de Divisas</h3>
                <p>Realiza transacciones de compra y venta de monedas de forma r√°pida y segura</p>
            </div>
        </div>

        <!-- Service 3: Historial de Transacciones -->
        <div class="service-row">
            <div class="service-visual">
                <div class="service-image">
                    <img src="{% static 'webapp/pantalla_principal_servicios/3Historial.png' %}" alt="Historial de Transacciones" class="service-visual-img">
                </div>
            </div>
            <div class="service-content">
                <div class="service-icon">
                    <img src="{% static 'webapp/pantalla_principal_servicios/3HistorialIcono.png' %}" alt="Icono Historial" class="service-icon-img">
                </div>
                <h3>Historial de Transacciones</h3>
                <p>Accede a un registro detallado de todas tus operaciones realizadas</p>
            </div>
        </div>

        <!-- Service 4: Autenticaci√≥n Segura -->
        <div class="service-row">
            <div class="service-visual">
                <div class="service-image">
                    <img src="{% static 'webapp/pantalla_principal_servicios/4Autenticacion.png' %}" alt="Autenticaci√≥n Segura" class="service-visual-img">
                </div>
            </div>
            <div class="service-content">
                <div class="service-icon">
                    <img src="{% static 'webapp/pantalla_principal_servicios/4AutenticacionIcono.png' %}" alt="Icono Autenticaci√≥n" class="service-icon-img">
                </div>
                <h3>Autenticaci√≥n Segura</h3>
                <p>Protege tu cuenta con medidas de protecci√≥n avanzadas, como autenticaci√≥n en dos pasos</p>
            </div>
        </div>

        <!-- Service 5: Notificaciones Personalizadas -->
        <div class="service-row">
            <div class="service-visual">
                <div class="service-image">
                    <img src="{% static 'webapp/pantalla_principal_servicios/5Notificacion.png' %}" alt="Notificaciones Personalizadas" class="service-visual-img">
                </div>
            </div>
            <div class="service-content">
                <div class="service-icon">
                    <img src="{% static 'webapp/pantalla_principal_servicios/5NotificacionIcono.png' %}" alt="Icono Notificaciones" class="service-icon-img">
                </div>
                <h3>Notificaciones Personalizadas</h3>
                <p>Recibe notificaciones cuando las tasas de cambio var√≠en seg√∫n tus preferencias</p>
            </div>
        </div>
    </div>
</div>

<script>
function refreshRates() {
    const btn = document.getElementById('refresh-btn');
    const originalContent = btn.innerHTML;
    
    // Agregar clase de loading y cambiar contenido
    btn.classList.add('loading');
    btn.innerHTML = '‚è≥';
    btn.disabled = true;
    
    // Simular un peque√±o delay para mostrar la animaci√≥n
    setTimeout(() => {
        location.reload();
    }, 500);
}

(function () {
  // UI refs
  const amount = document.getElementById("simu-amount");
  const from   = document.getElementById("simu-from");
  const to     = document.getElementById("simu-to");
  const swap   = document.getElementById("simu-swap");
  const calc   = document.getElementById("simu-calc");
  const copyBt = document.getElementById("simu-copy");
  const clear  = document.getElementById("simu-clear");
  const out    = document.getElementById("simu-result-main");
  const detail = document.getElementById("simu-result-detail");

  // Estado din√°mico
  let CODES = [];                   // ['USD','EUR','PYG',...]
  const META = Object.create(null); // code -> { name, decimals, pyg_per_unit }

  // Helpers
  const nf = (code) => new Intl.NumberFormat("es-ES", {
    minimumFractionDigits: (META[code]?.decimals ?? 2),
    maximumFractionDigits: (META[code]?.decimals ?? 2),
  });

  function buildOptions(selectEl, preferCode) {
    selectEl.innerHTML = "";
    CODES.forEach(code => {
      const opt = document.createElement("option");
      opt.value = code;
      const name = META[code]?.name || code;
      opt.textContent = `${code}${code === "PYG" ? " (‚Ç≤)" : ""} ‚Äî ${name}`;
      selectEl.appendChild(opt);
    });
    // Selecci√≥n por defecto si existe ese c√≥digo
    if (preferCode && CODES.includes(preferCode)) {
      selectEl.value = preferCode;
    } else if (CODES.length) {
      selectEl.value = CODES[0];
    }
  }

  function enforceDifferent(changed, other) {
    if (changed.value === other.value) {
      // eleg√≠ el primer c√≥digo distinto
      const target = CODES.find(c => c !== changed.value);
      if (target) other.value = target;
    }
  }

  function compute() {
    const rawTxt = (amount.value || "").toString().replace(",", ".");
    const raw = parseFloat(rawTxt);
    if (isNaN(raw) || raw <= 0) {
      out.textContent = "‚Äî";
      detail.textContent = "Ingres√° un monto para calcular";
      return;
    }
    const a = from.value;
    const b = to.value;
    if (!META[a] || !META[b]) return;

    // A->PYG->B :  (pyg_per_unit_A / pyg_per_unit_B)
    const pygA = META[a].pyg_per_unit;
    const pygB = META[b].pyg_per_unit;
    const rateAB = pygA / pygB;

    const val = raw * rateAB;
    out.textContent = `${nf(b).format(val)} ${b}`;
    detail.innerHTML = `1 ${a} = ${nf(b).format(rateAB)} ${b}`;
  }

  function attachListeners() {
    // Recalcular cuando cambie algo
    ["input", "change"].forEach(evt => {
      amount.addEventListener(evt, compute);
      from.addEventListener(evt, () => { enforceDifferent(from, to); compute(); });
      to.addEventListener(evt, () => { enforceDifferent(to, from); compute(); });
    });

    // Swap siempre deja distintos
    swap.addEventListener("click", () => {
      const temp = from.value;
      from.value = to.value;
      to.value = temp;
      enforceDifferent(from, to);
      compute();
    });

    calc.addEventListener("click", compute);

    copyBt.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(out.textContent);
        copyBt.textContent = "¬°Copiado!";
        setTimeout(() => (copyBt.textContent = "Copiar"), 1200);
      } catch (e) {}
    });

    clear.addEventListener("click", () => {
      amount.value = "";
      out.textContent = "‚Äî";
      detail.textContent = "Ingres√° un monto para calcular";
    });
  }

async function boot() {
    try {
        // üëá ac√° pedimos al backend
        const res = await fetch("{% url 'api_currencies' %}", { cache: "no-store" });
        const payload = await res.json();
        const items = payload.items || [];

        console.log("Monedas recibidas:", items); // üëà pod√©s ver en consola lo que trae el backend

        // Llenar la estructura META y CODES
        const byCode = {};
        items.forEach(it => { byCode[it.code] = it; });

        // Aseguramos que exista PYG
        if (!byCode["PYG"]) {
            byCode["PYG"] = { code: "PYG", name: "Guaran√≠", decimals: 0, pyg_per_unit: 1.0 };
        }

        // Ordenamos monedas: PYG primero
        CODES = Object.keys(byCode).sort((a, b) =>
            a === "PYG" ? -1 : b === "PYG" ? 1 : a.localeCompare(b)
        );

        CODES.forEach(code => { META[code] = byCode[code]; });

        // Armar selects
        buildOptions(from, "USD");
        buildOptions(to, "PYG");
        enforceDifferent(from, to);

        attachListeners();
        compute(); // c√°lculo inicial
    } catch (err) {
        console.error("No se pudieron cargar monedas:", err);
    }
}

boot();


})();
</script>

{% endblock %}
