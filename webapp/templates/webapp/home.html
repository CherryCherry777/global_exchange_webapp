{% extends 'webapp/base.html' %}
{% load static %}
{% block title %}Global Exchange - Inicio{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'webapp/home.css' %}">
{% endblock %}

{% block content %}


<div class="main-home-container">
    <!-- Main Content Row -->
    <div class="main-content-row">
        
        <!-- Left Section: Currency Rates Table -->
        <div class="rates-section">
            <div class="rates-container">
                <!-- Date Header -->
                <div class="rates-header">
                    <div class="date-display">
                        {% if last_update %}
                            Fecha: {{ last_update|date:"d/m/Y H:i" }}
                        {% else %}
                            Fecha: No disponible
                        {% endif %}
                    </div>
                    <button id="refresh-btn" onclick="refreshRates()" class="refresh-button" title="Actualizar cotizaciones">
                        <img src="{% static 'webapp/home/actualizar.png' %}" alt="Actualizar" class="refresh-icon">
                    </button>
                </div>

                <!-- Currency Rates Table -->
                <div class="rates-table-container">
                    <table class="rates-table">
                        <thead>
                            <tr>
                                <th>Moneda</th>
                                <th>Compra</th>
                                <th>Venta</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for currency in currencies %}
                            <tr>
                                <td class="currency-cell">
                                    {% if currency.flag_image %}
                                        <img src="{{ currency.flag_image.url }}" alt="{{ currency.name }}" class="currency-flag">
                                    {% endif %}
                                    <span class="currency-name">{{ currency.name }}</span>
                                </td>
                                <td class="rate-cell">{{ currency.totalCompra|floatformat:currency.decimales_monto }}</td>
                                <td class="rate-cell">{{ currency.totalVenta|floatformat:currency.decimales_monto }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Right Section: Currency Converter -->
        <div class="converter-section">
            <div class="converter-container">
                <h2 class="converter-title">
                    <span class="yellow-text">Conversor de</span> <span class="white-text">moneda</span>
                </h2>
                <p class="converter-subtitle">Selecciona la moneda y el monto de cotización</p>
                
                <div class="converter-form">
                    <!-- From Currency -->
                    <div class="converter-field">
                        <label class="field-label">Tengo esta moneda</label>
                        <div class="field-row">
                            <div class="select-wrapper">
                                <select id="simu-from" class="currency-select">
                                    <option value="USD" selected>DÓLAR</option>
                                    <option value="PYG">GUARANÍ</option>
                                    <option value="EUR">EURO</option>
                                </select>
                                <img src="{% static 'webapp/home/tick.png' %}" alt="dropdown" class="select-arrow">
                            </div>
                            <input id="simu-amount" type="number" step="0.01" min="0" class="amount-input">
                        </div>
                    </div>

                    <!-- To Currency -->
                    <div class="converter-field">
                        <label class="field-label">Quiero esta moneda</label>
                        <div class="field-row">
                            <div class="select-wrapper">
                                <select id="simu-to" class="currency-select">
                                    <option value="PYG" selected>GUARANÍ</option>
                                    <option value="USD">DÓLAR</option>
                                    <option value="EUR">EURO</option>
                                </select>
                                <img src="{% static 'webapp/home/tick.png' %}" alt="dropdown" class="select-arrow">
                            </div>
                            <input type="text" readonly class="result-input" id="simu-result-main">
                        </div>
                    </div>

                    <!-- Action Button -->
                    <div class="converter-actions">
                        <button id="simu-intercambiar" type="button" class="intercambiar-button">INTERCAMBIAR</button>
                    </div>

                    <!-- Result Details -->
                    <div class="converter-result">
                        <p id="simu-result-detail" class="result-detail">Ingresá un monto para calcular</p>
                    </div>

                    <!-- Reference Text -->
                    <div class="reference-text">
                        <p>*Última actualización: 12/09/2025 - 01:49 - Cotizaciones meramente de referencia.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


<div class="homepage-services">
    <div class="container">
        <h2>Nuestros Servicios</h2>
        
        <!-- Service 1: Consulta de Tasas de Cambio -->
        <div class="service-row">
            <div class="service-visual">
                <div class="service-image">
                    <img src="{% static 'webapp/pantalla_principal_servicios/1Consulta.png' %}" alt="Consulta de Tasas de Cambio" class="service-visual-img">
                </div>
            </div>
            <div class="service-content">
                <div class="service-icon">
                    <img src="{% static 'webapp/pantalla_principal_servicios/1ConsultaIcono.png' %}" alt="Icono Consulta" class="service-icon-img">
                </div>
                <h3>Consulta de Tasas de Cambio</h3>
                <p>Revisa el valor actualizado de diferentes monedas en tiempo real</p>
            </div>
        </div>

        <!-- Service 2: Compra y Venta de Divisas -->
        <div class="service-row">
            <div class="service-visual">
                <div class="service-image">
                    <img src="{% static 'webapp/pantalla_principal_servicios/2CompraVenta.png' %}" alt="Compra y Venta de Divisas" class="service-visual-img">
                </div>
            </div>
            <div class="service-content">
                <div class="service-icon">
                    <img src="{% static 'webapp/pantalla_principal_servicios/2CompraVentaIcono.png' %}" alt="Icono Compra Venta" class="service-icon-img">
                </div>
                <h3>Compra y Venta de Divisas</h3>
                <p>Realiza transacciones de compra y venta de monedas de forma rápida y segura</p>
            </div>
        </div>

        <!-- Service 3: Historial de Transacciones -->
        <div class="service-row">
            <div class="service-visual">
                <div class="service-image">
                    <img src="{% static 'webapp/pantalla_principal_servicios/3Historial.png' %}" alt="Historial de Transacciones" class="service-visual-img">
                </div>
            </div>
            <div class="service-content">
                <div class="service-icon">
                    <img src="{% static 'webapp/pantalla_principal_servicios/3HistorialIcono.png' %}" alt="Icono Historial" class="service-icon-img">
                </div>
                <h3>Historial de Transacciones</h3>
                <p>Accede a un registro detallado de todas tus operaciones realizadas</p>
            </div>
        </div>

        <!-- Service 4: Autenticación Segura -->
        <div class="service-row">
            <div class="service-visual">
                <div class="service-image">
                    <img src="{% static 'webapp/pantalla_principal_servicios/4Autenticacion.png' %}" alt="Autenticación Segura" class="service-visual-img">
                </div>
            </div>
            <div class="service-content">
                <div class="service-icon">
                    <img src="{% static 'webapp/pantalla_principal_servicios/4AutenticacionIcono.png' %}" alt="Icono Autenticación" class="service-icon-img">
                </div>
                <h3>Autenticación Segura</h3>
                <p>Protege tu cuenta con medidas de protección avanzadas, como autenticación en dos pasos</p>
            </div>
        </div>

        <!-- Service 5: Notificaciones Personalizadas -->
        <div class="service-row">
            <div class="service-visual">
                <div class="service-image">
                    <img src="{% static 'webapp/pantalla_principal_servicios/5Notificacion.png' %}" alt="Notificaciones Personalizadas" class="service-visual-img">
                </div>
            </div>
            <div class="service-content">
                <div class="service-icon">
                    <img src="{% static 'webapp/pantalla_principal_servicios/5NotificacionIcono.png' %}" alt="Icono Notificaciones" class="service-icon-img">
                </div>
                <h3>Notificaciones Personalizadas</h3>
                <p>Recibe notificaciones cuando las tasas de cambio varíen según tus preferencias</p>
            </div>
        </div>
    </div>
</div>

<script>
function refreshRates() {
    const btn = document.getElementById('refresh-btn');
    const originalContent = btn.innerHTML;
    
    // Agregar clase de loading y cambiar contenido
    btn.classList.add('loading');
    btn.innerHTML = '⏳';
    btn.disabled = true;
    
    // Simular un pequeño delay para mostrar la animación
    setTimeout(() => {
        location.reload();
    }, 500);
}

(function () {
  // UI refs
  const amount = document.getElementById("simu-amount");
  const from   = document.getElementById("simu-from");
  const to     = document.getElementById("simu-to");
  const intercambiar = document.getElementById("simu-intercambiar");
  const out    = document.getElementById("simu-result-main");
  const detail = document.getElementById("simu-result-detail");

  // Estado dinámico
  let CODES = [];                   // ['USD','EUR','PYG',...]
  const META = Object.create(null); // code -> { name, decimals, pyg_per_unit }

  // Helpers
  const nf = (code) => new Intl.NumberFormat("es-ES", {
    minimumFractionDigits: (META[code]?.decimals ?? 2),
    maximumFractionDigits: (META[code]?.decimals ?? 2),
  });

  function buildOptions(selectEl, preferCode) {
    selectEl.innerHTML = "";
    CODES.forEach(code => {
      const opt = document.createElement("option");
      opt.value = code;
      const name = META[code]?.name || code;
      // Show currency names in uppercase for the new design
      if (code === "USD") {
        opt.textContent = "DÓLAR";
      } else if (code === "PYG") {
        opt.textContent = "GUARANÍ";
      } else if (code === "EUR") {
        opt.textContent = "EURO";
      } else {
        opt.textContent = name.toUpperCase();
      }
      selectEl.appendChild(opt);
    });
    // Selección por defecto si existe ese código
    if (preferCode && CODES.includes(preferCode)) {
      selectEl.value = preferCode;
    } else if (CODES.length) {
      selectEl.value = CODES[0];
    }
  }

  function enforceDifferent(changed, other) {
    if (changed.value === other.value) {
      // elegí el primer código distinto
      const target = CODES.find(c => c !== changed.value);
      if (target) other.value = target;
    }
  }

  function compute() {
    const rawTxt = (amount.value || "").toString().replace(",", ".");
    const raw = parseFloat(rawTxt);
    if (isNaN(raw) || raw <= 0) {
      out.value = "—";
      detail.textContent = "Ingresá un monto para calcular";
      return;
    }
    const a = from.value;
    const b = to.value;
    if (!META[a] || !META[b]) return;

    // A->PYG->B :  (pyg_per_unit_A / pyg_per_unit_B)
    const pygA = META[a].pyg_per_unit;
    const pygB = META[b].pyg_per_unit;
    const rateAB = pygA / pygB;

    const val = raw * rateAB;
    out.value = `${nf(b).format(val)} ${b}`;
    detail.innerHTML = `1 ${a} = ${nf(b).format(rateAB)} ${b}`;
  }

  function attachListeners() {
    // Recalcular cuando cambie algo
    ["input", "change"].forEach(evt => {
      amount.addEventListener(evt, compute);
      from.addEventListener(evt, () => { enforceDifferent(from, to); compute(); });
      to.addEventListener(evt, () => { enforceDifferent(to, from); compute(); });
    });

    // Botón de intercambiar
    intercambiar.addEventListener("click", () => {
      const temp = from.value;
      from.value = to.value;
      to.value = temp;
      enforceDifferent(from, to);
      compute();
    });

    // clear.addEventListener("click", () => {
    //   amount.value = "";
    //   out.value = "—";
    //   detail.textContent = "Ingresá un monto para calcular";
    // }); // Removed clear button functionality
  }

async function boot() {
    try {
        // acá se pide al backend
        const res = await fetch("{% url 'api_currencies' %}", { cache: "no-store" });
        const payload = await res.json();
        const items = payload.items || [];

        console.log("Monedas recibidas:", items); // para poder ver en consola lo que trae el backend

        // Llenar la estructura META y CODES
        const byCode = {};
        items.forEach(it => { byCode[it.code] = it; });

        // Aseguramos que exista PYG
        if (!byCode["PYG"]) {
            byCode["PYG"] = { code: "PYG", name: "Guaraní", decimals: 0, pyg_per_unit: 1.0 };
        }

        // Ordenamos monedas: PYG primero
        CODES = Object.keys(byCode).sort((a, b) =>
            a === "PYG" ? -1 : b === "PYG" ? 1 : a.localeCompare(b)
        );

        CODES.forEach(code => { META[code] = byCode[code]; });

        // Armar selects
        buildOptions(from, "USD");
        buildOptions(to, "PYG");
        enforceDifferent(from, to);

        attachListeners();
        compute(); // cálculo inicial
    } catch (err) {
        console.error("No se pudieron cargar monedas:", err);
    }
}

boot();

})();
</script>

{% endblock %}
