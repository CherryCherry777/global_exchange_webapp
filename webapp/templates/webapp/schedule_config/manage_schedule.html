{% extends 'webapp/base.html' %}
{% load static %}

{% block title %}Configuraci√≥n de temporizadores{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'webapp/css/cotizaciones/modify_quote.css' %}">
{% endblock %}

{% block content %}
<div class="modify-quote-container">
    <div class="main-content">

        <!-- Header -->
        <div class="modify-quote-header">
            <div class="header-content">
                <a href="{% url 'landing' %}" class="back-button">‚Üê Volver al Panel</a>
                <div class="header-text">
                    <h1 class="modify-quote-title">Configuraci√≥n del Sistema</h1>
                    <p class="modify-quote-subtitle">Programaci√≥n autom√°tica y temporizadores globales</p>
                </div>
            </div>
        </div>

        <!-- ================================================= -->
        <!-- 1. Programaci√≥n de correos autom√°ticos -->
        <!-- ================================================= -->
        <div class="modify-section">
            <h2 class="section-title">üì® Env√≠o autom√°tico de correos</h2>

            <form method="post" class="modify-form">
                {% csrf_token %}
                <input type="hidden" name="save_email" value="1">

                <div class="form-row single-field-row">
                    <label class="field-label">Frecuencia:</label>
                    <select name="frequency" class="form-input" id="email-frequency">
                        <option value="daily" {% if email_config.frequency == 'daily' %}selected{% endif %}>Diario</option>
                        <option value="weekly" {% if email_config.frequency == 'weekly' %}selected{% endif %}>Semanal</option>
                        <option value="custom" {% if email_config.frequency == 'custom' %}selected{% endif %}>Personalizado</option>
                    </select>
                </div>

                <div class="form-row" id="email-weekly" {% if email_config.frequency != "weekly" %}style="display:none"{% endif %}>
                    <div class="form-field">
                        <label class="field-label">D√≠a:</label>
                        <select name="weekday" class="form-input">
                            <option value="monday" {% if email_config.weekday == 'monday' %}selected{% endif %}>Lunes</option>
                            <option value="tuesday" {% if email_config.weekday == 'tuesday' %}selected{% endif %}>Martes</option>
                            <option value="wednesday" {% if email_config.weekday == 'wednesday' %}selected{% endif %}>Mi√©rcoles</option>
                            <option value="thursday" {% if email_config.weekday == 'thursday' %}selected{% endif %}>Jueves</option>
                            <option value="friday" {% if email_config.weekday == 'friday' %}selected{% endif %}>Viernes</option>
                            <option value="saturday" {% if email_config.weekday == 'saturday' %}selected{% endif %}>S√°bado</option>
                            <option value="sunday" {% if email_config.weekday == 'sunday' %}selected{% endif %}>Domingo</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-field">
                        <label class="field-label">Hora:</label>
                        <input type="number" name="hour" value="{{ email_config.hour }}" min="0" max="23" class="form-input">
                    </div>
                    <div class="form-field">
                        <label class="field-label">Minuto:</label>
                        <input type="number" name="minute" value="{{ email_config.minute }}" min="0" max="59" class="form-input">
                    </div>
                </div>

                <div class="form-row" id="email-custom" {% if email_config.frequency != "custom" %}style="display:none"{% endif %}>
                    <div class="form-field">
                        <label class="field-label">Intervalo (minutos):</label>
                        <input type="number" name="interval_minutes" value="{{ email_config.interval_minutes }}" class="form-input">
                    </div>
                </div>

                <div class="action-buttons">
                    <button type="submit" class="save-button">Guardar</button>
                </div>
            </form>
        </div>

        <!-- ================================================= -->
        <!-- 2. Reseteo global de l√≠mites -->
        <!-- ================================================= -->
        <div class="modify-section">
            <h2 class="section-title">‚åõ Temporizador Global de L√≠mites</h2>

            <form method="post" class="modify-form">
                {% csrf_token %}
                <input type="hidden" name="save_limites" value="1">

                <div class="form-row single-field-row">
                    
                    <label class="field-label">
                        <input type="checkbox" name="is_active" {% if limite_config.is_active %}checked{% endif %}>
                        ¬øActivado?
                    </label>
                    <label class="field-label">
                        <input type="checkbox" name="reset_history">
                        Reiniciar historial de ejecuci√≥n (permitir ejecutar de nuevo hoy / este mes)
                    </label>
                </div>

                <div class="form-row single-field-row">
                    <label class="field-label">Frecuencia:</label>
                    <select name="frequency" class="form-input" id="limite-frequency">
                        <option value="daily" {% if limite_config.frequency == "daily" %}selected{% endif %}>Diario</option>
                        <option value="monthly" {% if limite_config.frequency == "monthly" %}selected{% endif %}>Mensual</option>
                    </select>
                </div>

                <div class="form-row">
                    <div class="form-field">
                        <label class="field-label">Hora:</label>
                        <input type="number" name="hour" value="{{ limite_config.hour }}" min="0" max="23" class="form-input">
                    </div>
                    <div class="form-field">
                        <label class="field-label">Minuto:</label>
                        <input type="number" name="minute" value="{{ limite_config.minute }}" min="0" max="59" class="form-input">
                    </div>
                </div>

                <div class="form-row single-field-row" id="limite-monthly" {% if limite_config.frequency != "monthly" %}style="display:none"{% endif %}>
                    <label class="field-label">D√≠a del mes:</label>
                    <input type="number" name="month_day" value="{{ limite_config.month_day }}" min="1" max="31" class="form-input">
                </div>

                <div class="action-buttons">
                    <button type="submit" class="save-button">Guardar</button>
                </div>
            </form>
        </div>

        <!-- ================================================= -->
        <!-- 3. Expiraci√≥n autom√°tica de transacciones -->
        <!-- ================================================= -->
        <div class="modify-section">
            <h2 class="section-title">‚ö†Ô∏è Expiraci√≥n de Transacciones</h2>

            <form method="post" class="modify-form">
                {% csrf_token %}
                <input type="hidden" name="save_expiraciones" value="1">

                {% for item in expiraciones %}
                <div class="form-row">
                    <label class="field-label">{{ item.get_medio_display }}</label>
                    <input type="number" name="{{ item.medio }}" value="{{ item.minutos_expiracion }}" class="form-input">
                </div>
                {% endfor %}

                <div class="action-buttons">
                    <button type="submit" class="save-button">Guardar</button>
                </div>
            </form>
        </div>

    </div>
</div>

<script>
const emailSelect = document.getElementById("email-frequency");
emailSelect.addEventListener("change", function() {
    document.getElementById("email-weekly").style.display = this.value === "weekly" ? "flex" : "none";
    document.getElementById("email-custom").style.display = this.value === "custom" ? "flex" : "none";
});


/////////////////////////////////////////////////////////////////////////////////////////////////////////
//Comportamiento del formulario para el cambio de fechas de reinicio de los l√≠mites de venta
////////////////////////////////////////////////////////////////////////////////////////////////////////

const limiteSelect = document.getElementById("limite-frequency");
const limitForm = document.querySelector('form input[name="save_limites"]').closest("form");

const hourInput = limitForm.querySelector('input[name="hour"]');
const minuteInput = limitForm.querySelector('input[name="minute"]');
const monthDayInput = limitForm.querySelector('input[name="month_day"]');
const monthRow = limitForm.querySelector('#limite-monthly');

// Cargar valores actuales desde el backend (inyectados por Django)
const savedConfigs = {
    daily: {
        hour: {{ limite_daily.hour }},
        minute: {{ limite_daily.minute }},
        day: null
    },
    monthly: {
        hour: {{ limite_monthly.hour }},
        minute: {{ limite_monthly.minute }},
        day: {{ limite_monthly.month_day|default:"1" }}
    }
};

limiteSelect.addEventListener("change", function() {
    const freq = this.value;
    const cfg = savedConfigs[freq];

    hourInput.value = cfg.hour ?? 0;
    minuteInput.value = cfg.minute ?? 0;

    console.log(hourInput.value)
    console.log(minuteInput.value)
    if (freq === "monthly") {
        monthRow.style.display = "flex";
        monthDayInput.value = cfg.day ?? 1;
    } else {
        monthRow.style.display = "none";
    }
});

// Forzar que el formulario muestre los valores correctos al cargar
limiteSelect.dispatchEvent(new Event("change"));

</script>
{% endblock %}
