{% extends "webapp/base.html" %}
{% load static %}
{% load permissions_tags %}
{% block extra_css %}
<link rel="stylesheet" href="{% static 'webapp/css/paginas_principales/home.css' %}">
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- üÜï Estilos del wizard -->
<style>
  .wizard-step.d-none { display: none; }
  .wizard-step.active { display: block; }

  /* üÜï Indicador visual de pasos */
  .wizard-header {
    display: flex;
    justify-content: center;
    gap: 2rem;
    margin-bottom: 1.5rem;
  }
  .wizard-step-indicator {
    display: flex;
    flex-direction: column;
    align-items: center;
    font-weight: 500;
    color: #888;
  }
  .wizard-step-indicator.active {
    color: #007bff;
  }
  .wizard-step-indicator span {
    background: #ccc;
    color: white;
    border-radius: 50%;
    width: 28px;
    height: 28px;
    display: flex;
    justify-content: center;
    align-items: center;
    margin-bottom: 0.4rem;
  }
  .wizard-step-indicator.active span {
    background: #007bff;
  }
</style>

{% endblock %}

{% block title %}Compra y Venta de Divisas{% endblock %}

{% block content %}
<div class="container py-4">
    <h2 class="converter-title">
        <span class="yellow-text">Compra</span> <span class="black-text">venta</span>
    </h2>

    <!-- üÜï Indicador superior de pasos -->
    <div class="wizard-header">
        <div id="indicator-step1" class="wizard-step-indicator active">
            <span>1</span> Selecci√≥n
        </div>
        <div id="indicator-step2" class="wizard-step-indicator">
            <span>2</span> Revisi√≥n
        </div>
    </div>

    <form method="post">
        {% csrf_token %}

        <!-- üÜï PASO 1: Selecci√≥n -->
        <div id="step-1" class="wizard-step active">
            <div class="converter-section mb-4">
                <!-- Select Compra/Venta -->
                <div class="converter-section">
                    <div class="converter-container">
                        <p class="converter-subtitle">Selecciona la moneda e ingresa el monto de cotizaci√≥n</p>
                        
                        <div class="converter-form">
                            <!-- From Currency -->
                            <div class="converter-field">
                                <label class="field-label">Tengo esta moneda</label>
                                <div class="field-row">
                                    <div class="select-wrapper">
                                        <select id="simu-from" name="moneda_origen" class="currency-select"></select>
                                        <img src="{% static 'webapp/home/tick.png' %}" alt="dropdown" class="select-arrow">
                                    </div>
                                    <input id="simu-amount" name="monto_origen" type="number" step="0.01" min="0" class="amount-input">
                                </div>
                            </div>

                            <!-- To Currency -->
                            <div class="converter-field">
                                <label class="field-label">Quiero esta moneda</label>
                                <div class="field-row">
                                    <div class="select-wrapper">
                                        <select id="simu-to" name="moneda_destino" class="currency-select"></select>
                                        <img src="{% static 'webapp/home/tick.png' %}" alt="dropdown" class="select-arrow">
                                    </div>
                                    <input name="monto_destino" type="text" readonly class="result-input" id="simu-result-main">
                                </div>
                            </div>

                            <div class="converter-actions">
                                <button id="simu-intercambiar" type="button" class="intercambiar-button">INTERCAMBIAR</button>
                            </div>

                            {% is_usuario_asociado request.user as usuario_asociado %}
                            {% if usuario_asociado %}
                                <!-- M√©todo de Pago perspectiva del cliente -->
                                <div class="converter-field">
                                    <label class="field-label">Pagar con:</label>
                                        
                                    <div class="tab-row" id="pago-tabs">
                                    {% for tipo in tipos_pago %}
                                        <button type="button" class="tab-btn {% if forloop.first %}active{% endif %}" data-tipo-general="{{ tipo.id }}">
                                        {{ tipo.nombre }}
                                        </button>
                                    {% endfor %}
                                    </div>

                                    <div class="field-row">
                                        <div class="select-wrapper">
                                            <select id="simu-metodo-pago" name="medio_pago" class="currency-select">
                                            </select>
                                            <img src="{% static 'webapp/home/tick.png' %}" alt="dropdown" class="select-arrow">
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- M√©todo de Cobro perspectiva del cliente -->
                                <div class="converter-field">
                                    <label class="field-label">Recibir en:</label>

                                    <div class="tab-row" id="cobro-tabs">
                                    {% for tipo in tipos_cobro %}
                                        <button type="button"class="tab-btn {% if forloop.first %}active{% endif %}" data-tipo-general="{{ tipo.id }}">
                                        {{ tipo.nombre }}
                                        </button>
                                    {% endfor %}
                                    </div>
                                    
                                    <div class="field-row">
                                        <div class="select-wrapper">
                                            <select id="simu-metodo-cobro" name="medio_cobro" class="currency-select">
                                            </select>
                                            <img src="{% static 'webapp/home/tick.png' %}" alt="dropdown" class="select-arrow">
                                        </div>
                                    </div>
                                </div>

                            {% endif %}

                            <div class="converter-result">
                                <p id="simu-result-detail" class="result-detail">Ingres√° un monto para calcular</p>
                            </div>

                        </div>
                    </div>
                </div>
                <h5>Operaci√≥n</h5>

                    <input type="hidden" id="input-tipo" name="tipo">
                    <input type="hidden" id="input-moneda-origen" name="moneda_origen">
                    <input type="hidden" id="input-moneda-destino" name="moneda_destino">
                    <input type="hidden" id="input-monto-origen" name="monto_origen">
                    <input type="hidden" id="input-monto-destino" name="monto_destino">
                    <input type="hidden" id="input-tasa-cambio" name="tasa_cambio">
                    <input type="hidden" id="input-medio-pago-id" name="medio_pago_id">
                    <input type="hidden" id="input-medio-pago-type" name="medio_pago_type">
                    <input type="hidden" id="input-medio-cobro-id" name="medio_cobro_id">
                    <input type="hidden" id="input-medio-cobro-type" name="medio_cobro_type">

            </div>
            <div class="converter-actions mt-4 text-end">
                <button type="button" id="next-step" class="btn btn-primary">Continuar</button>
            </div>
        </div>
         <!-- üÜï PASO 2: Revisi√≥n -->
        <div id="step-2" class="wizard-step d-none">
            <h4>Revisi√≥n y Confirmaci√≥n</h4>
            <p>Verific√° los detalles antes de confirmar tu operaci√≥n.</p>
            <hr>

            <ul class="list-group mb-3">
                <li class="list-group-item d-flex justify-content-between">
                <strong>Tipo de operaci√≥n:</strong> <span id="resumen-tipo"></span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                <strong>Monto origen:</strong> <span id="resumen-origen"></span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                <strong>Monto destino:</strong> <span id="resumen-destino"></span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                <strong>M√©todo de pago:</strong> <span id="resumen-pago"></span>
                </li>
                <li class="list-group-item d-flex justify-content-between">
                <strong>M√©todo de cobro:</strong> <span id="resumen-cobro"></span>
                </li>
            </ul>

            <div class="converter-actions d-flex justify-content-between mt-3">
                <button type="button" id="prev-step" class="btn btn-secondary">Atr√°s</button>
                <button type="submit" class="btn btn-success">Confirmar operaci√≥n</button>
            </div>
        </div>

    </form>

    {% if resultado %}
        <div class="alert alert-success mt-4">
            <strong>Resultado:</strong> {{ resultado }}
        </div>
    {% endif %}
</div>

<script>
(async function() {
    const amount = document.getElementById("simu-amount");
    const from = document.getElementById("simu-from");
    const to = document.getElementById("simu-to");
    const intercambiar = document.getElementById("simu-intercambiar");
    const out = document.getElementById("simu-result-main");
    const detail = document.getElementById("simu-result-detail");
    const metodoPago = document.getElementById("simu-metodo-pago");
    const metodoCobro = document.getElementById("simu-metodo-cobro");

    let CODES = [];
    const META = Object.create(null);

    function nf(value, currencyCode) {
        // Determina cu√°ntos decimales mostrar seg√∫n la moneda
        // Si es "PYG" (guaran√≠ paraguayo), se usan 0 decimales
        // Si no, busca en el objeto META[currencyCode] la propiedad "decimals"
        // y si no existe, usa por defecto 2 decimales
        const decimals = currencyCode === "PYG" ? 0 : (META[currencyCode]?.decimals ?? 2);

        // Crea un formateador num√©rico con configuraci√≥n regional "es-ES"
        // y fija la cantidad de decimales al valor calculado arriba
        return new Intl.NumberFormat("es-ES", {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        }).format(value); // Aplica el formateador al n√∫mero recibido
    }

    function buildOptions(selectEl, preferCode) {
        // Limpia el contenido actual del <select>
        selectEl.innerHTML = "";

        // Recorre la lista de c√≥digos de moneda definida en CODES
        CODES.forEach(code => {
            // Crea una opci√≥n <option> para el select
            const opt = document.createElement("option");
            opt.value = code; // el valor de la opci√≥n ser√° el c√≥digo de moneda

            // Obtiene el nombre de la moneda desde META, o usa el c√≥digo si no existe
            const name = META[code]?.name || code;

            // Define el texto visible de la opci√≥n, con casos especiales
            if (code === "USD") opt.textContent = "D√ìLAR";
            else if (code === "PYG") opt.textContent = "GUARAN√ç";
            else if (code === "EUR") opt.textContent = "EURO";
            else opt.textContent = name.toUpperCase(); // para el resto, usa el nombre en may√∫sculas

            // Agrega la opci√≥n al <select>
            selectEl.appendChild(opt);
        });

        // Selecciona por defecto el c√≥digo preferido si existe y est√° en CODES
        if (preferCode && CODES.includes(preferCode)) 
            selectEl.value = preferCode;
        // Si no hay preferencia v√°lida, selecciona el primer c√≥digo disponible
        else if (CODES.length) 
            selectEl.value = CODES[0];
    }

    // variables y listeners utilizados en enforceDifferent()
    let lastFrom = from.value;
    let lastTo = to.value;

    from.addEventListener("focus", () => lastFrom = from.value);
    to.addEventListener("focus", () => lastTo = to.value);

    function enforceDifferent(changed, other) {
        // Caso 1: si el usuario pone PYG en ambos
        if (from.value === "PYG" && to.value === "PYG") {
            const prev = (changed === from ? lastFrom : lastTo);
            const fallback = prev && prev !== "PYG"
                ? prev
                : (CODES.includes("USD") ? "USD" : CODES.find(c => c !== "PYG"));

            if (changed === from) to.value = fallback;
            else from.value = fallback;
        }

        // Caso 2: si el usuario pone la misma moneda en ambos (pero no es PYG)
        else if (from.value === to.value) {
            // el otro se fuerza a PYG
            if (changed === from) to.value = "PYG";
            else from.value = "PYG";
        }

        // Caso 3: si ninguno es PYG
        if (from.value !== "PYG" && to.value !== "PYG") {
            // el que no cambi√≥ se fuerza a PYG
            if (changed === from) to.value = "PYG";
            else from.value = "PYG";
        }
    }
    
    function compute() {
        // Convierte el valor ingresado en el campo "amount" a n√∫mero decimal.
        // Reemplaza coma por punto para asegurar compatibilidad.
        const raw = parseFloat((amount.value || "").toString().replace(",", "."));

        // Si no es un n√∫mero v√°lido o es menor/igual a 0, muestra un mensaje de error.
        if (isNaN(raw) || raw <= 0) {
            out.value = "‚Äî"; // salida vac√≠a con guion
            detail.textContent = "Ingres√° un monto para calcular"; // mensaje para el usuario
            return; // corta la ejecuci√≥n
        }

        // Obtiene las monedas seleccionadas (desde y hacia)
        const a = from.value, b = to.value;

        // Verifica que ambas monedas existan en META (tabla con cotizaciones/definiciones)
        if (!META[a] || !META[b]) return;

        // Variables donde se guardar√°n el resultado y la tasa de cambio usada
        let val, rateAB;

        // Caso 1: convertir de Guaran√≠es (PYG) a otra moneda
        if (a === "PYG" && b !== "PYG") {
            val = raw / META[b].venta;   // Divide el monto en PYG por la tasa de venta de la moneda destino
            rateAB = META[b].venta;  // Calcula el tipo de cambio unitario
            detail.innerHTML = `1 ${b} = ${nf(rateAB, "PYG")} ${a}`; // Muestra el detalle de la tasa usada
        } 
        // Caso 2: convertir de otra moneda hacia Guaran√≠es
        else if (a !== "PYG" && b === "PYG") {
            val = raw * META[a].compra;  // Multiplica el monto por la tasa de compra de la moneda origen
            rateAB = META[a].compra;     // Guarda la tasa usada
            detail.innerHTML = `1 ${a} = ${nf(rateAB, "PYG")} ${b}`; // Muestra el detalle de la tasa
        } 
        // Caso inv√°lido: cuando se intenta convertir entre dos monedas que no son PYG
        else {
            out.value = "‚Äî"; 
            detail.textContent = "S√≥lo se permiten conversiones con Guaran√≠es"; 
            return;
        }

        // Muestra el resultado formateado en el campo de salida
        out.value = `${nf(val, b)} ${b}`;
    }

    function attachListeners() {
        // Agrega listeners a los campos de monto, moneda origen y moneda destino.
        // Se escucha tanto "input" (cuando el usuario escribe) como "change" (cuando cambia el valor).
        ["input","change"].forEach(evt => {
            // Cuando se modifica el monto, recalcula directamente
            amount.addEventListener(evt, compute);

            // Cuando cambia la moneda de origen (from)
            from.addEventListener(evt, async () => {
                enforceDifferent(from,to);     // fuerza que origen y destino no sean iguales
                await recargarMetodos();       // recarga m√©todos de pago/cobro disponibles
                compute();                     // recalcula el resultado
            });

            // Cuando cambia la moneda de destino (to)
            to.addEventListener(evt, async () => {
                enforceDifferent(to,from);     // igual que arriba, pero para destino
                await recargarMetodos();       // recarga m√©todos
                compute();                     // recalcula
            });
        });

        // Listener para el bot√≥n de "intercambiar" monedas
        intercambiar.addEventListener("click", async () => {
            // Intercambia los valores de las monedas
            const tmp = from.value; 
            from.value = to.value; 
            to.value = tmp;

            enforceDifferent(from,to);     // asegura que no queden iguales
            await recargarMetodos();       // recarga m√©todos acorde a la nueva selecci√≥n
            compute();                     // recalcula conversi√≥n
        });

        // Si existen selectores de m√©todos de pago y cobro, agrega listeners
        if (metodoPago && metodoCobro) {
            [metodoPago, metodoCobro].forEach(el => 
                el.addEventListener("change", async () => {
                    await updateRatesForMetodo(); // actualiza las tasas seg√∫n el m√©todo elegido
                    compute();                    // recalcula conversi√≥n
                })
            );
        }
    }

    async function updateRatesForMetodo() {
        try {
            // Si no existen los selectores de m√©todo de pago o cobro, no hace nada
            if (!metodoPago || !metodoCobro) return;

            // Funci√≥n auxiliar: obtiene el tipo general desde el atributo data-* de la opci√≥n seleccionada
            const getTipoGeneral = (select) => {
                // Obtiene el √≠ndice de la opci√≥n actualmente seleccionada en el <select>
                const idx = select.selectedIndex;

                // Si no hay ninguna opci√≥n seleccionada (√≠ndice < 0), devuelve cadena vac√≠a
                if (idx < 0) return "";

                // Devuelve el valor del atributo data-tipo-general de la opci√≥n seleccionada
                // Si no existe, devuelve cadena vac√≠a
                return select.options[idx].dataset.tipoGeneral || "";
            };

            // Obtiene los IDs (tipoGeneral o value) para pago y cobro
            const pagoId = getTipoGeneral(metodoPago);
            const cobroId = getTipoGeneral(metodoCobro);

            // Construye la URL hacia la API de monedas, pasando los IDs como query params
            const url = `{% url 'api_currencies' %}?tipo_metodo_pago_id=${pagoId}&tipo_metodo_cobro_id=${cobroId}`;
            
            // Llama a la API (sin cachear) para obtener las tasas actualizadas
            const res = await fetch(url, { cache:"no-store" });
            const payload = await res.json();

            // Extrae los items del JSON, o lista vac√≠a si no existe
            const items = payload.items || [];
            const byCode = {};

            // Convierte la lista de items en un diccionario indexado por el c√≥digo de moneda
            items.forEach(it => byCode[it.code] = it);

            // Si la API no incluy√≥ PYG, se asegura de a√±adirlo manualmente con valores neutros
            if (!byCode["PYG"]) 
                byCode["PYG"] = { code:"PYG", name:"Guaran√≠", decimals:0, venta:1.0, compra:1.0 };

            // Ordena los c√≥digos: PYG siempre primero, luego orden alfab√©tico
            CODES = Object.keys(byCode).sort((a,b)=> 
                a==="PYG"?-1 : b==="PYG"?1 : a.localeCompare(b)
            );

            // Actualiza el diccionario global META con la info por cada c√≥digo
            CODES.forEach(code => META[code] = byCode[code]);

            // Recalcula inmediatamente la conversi√≥n con las tasas nuevas
            compute();

        } catch(e) {
            // Si algo falla, loguea el error en consola
            console.error("Error al actualizar tasas:", e);
        }
    }

    async function recargarMetodos() {
        // Si no existen los selectores de m√©todo de pago o cobro, no hace nada
        if (!metodoPago || !metodoCobro) return;

        try {
            // Obtiene las referencias de los grupos de botones de tipo general
            const pagoTabs = document.getElementById("pago-tabs");
            const cobroTabs = document.getElementById("cobro-tabs");

            // Detecta qu√© bot√≥n est√° activo en cada grupo
            const tipoGeneralPago = pagoTabs?.querySelector(".tab-btn.active")?.dataset.tipoGeneral || null;
            const tipoGeneralCobro = cobroTabs?.querySelector(".tab-btn.active")?.dataset.tipoGeneral || null;

            // Llama a la API que devuelve los m√©todos disponibles seg√∫n la conversi√≥n seleccionada
            const res = await fetch(`{% url 'get_metodos_pago_cobro' %}?from=${from.value}&to=${to.value}`);
            const data = await res.json(); // Parseo del JSON de respuesta

            // Limpia las opciones actuales de ambos <select>
            metodoPago.innerHTML = "";
            metodoCobro.innerHTML = "";

            // üÜï Opci√≥n inicial por defecto
            const agregarOpcionInicial = (selectEl) => {
                const opt = document.createElement("option");
                opt.value = "";
                opt.textContent = "---Seleccione una opci√≥n---";
                opt.disabled = true;
                opt.selected = true;
                selectEl.appendChild(opt);
            };

            agregarOpcionInicial(metodoPago);
            agregarOpcionInicial(metodoCobro);

            // Funci√≥n auxiliar para crear un <option> a partir de un item recibido
            const crearOption = (item) => {
                const opt = document.createElement("option");
                opt.value = item.id; // el valor ser√° el id del m√©todo
                opt.dataset.tipoGeneral = item.tipo_general_id || ""; // guarda el tipo general en dataset

                // Seg√∫n el tipo de m√©todo, construye el texto visible en el select
                if (item.tipo.toLowerCase() === "tauser") {
                    opt.textContent = `${item.nombre} (${item.ubicacion || "Sin ubicaci√≥n"})`;
                } else if (item.tipo.toLowerCase() === "billetera") {
                    opt.textContent = `${item.nombre} - ${item.numero || ""} - ${item.entidad?.nombre || ""}`;
                } else if (item.tipo.toLowerCase() === "tarjeta") {
                    opt.textContent = `${item.nombre} - ${item.entidad?.nombre || ""}`;
                } else if (item.tipo.toLowerCase() === "transferencia") {
                    opt.textContent = `${item.entidad?.nombre || ""} - ${item.numero_cuenta || ""}`;
                } else {
                    opt.textContent = item.nombre; // caso por defecto
                }

                // Se guarda tambi√©n el content_type_id (para identificar modelo origen en backend)
                opt.dataset.contentTypeId = item.content_type_id || "";

                return opt; // devuelve el <option> ya construido
            };

            // === üîç Filtra los m√©todos seg√∫n el tipo general activo ===
            const metodosPagoFiltrados = data.metodo_pago.filter(
                (m) => !tipoGeneralPago || m.tipo_general_id == tipoGeneralPago
            );
            const metodosCobroFiltrados = data.metodo_cobro.filter(
                (m) => !tipoGeneralCobro || m.tipo_general_id == tipoGeneralCobro
            );

            // Agrega las opciones filtradas a los <select>
            metodosPagoFiltrados.forEach(item => metodoPago.appendChild(crearOption(item)));
            metodosCobroFiltrados.forEach(item => metodoCobro.appendChild(crearOption(item)));

            // Selecciona por defecto la primera opci√≥n visible (si existen)
            if (metodoPago.options.length) metodoPago.selectedIndex = 0;
            if (metodoCobro.options.length) metodoCobro.selectedIndex = 0;

            // Luego de recargar m√©todos, actualiza las tasas de cambio
            await updateRatesForMetodo();

        } catch (error) {
            // Si algo falla (error de red o API), lo muestra en consola
            console.error("Error al cargar m√©todos de pago/cobro:", error);
        }
    }
    
    function configurarTabsFiltro() {
        const pagoTabs = document.getElementById("pago-tabs");
        const cobroTabs = document.getElementById("cobro-tabs");

        const activar = async (grupo, btn) => {
            grupo.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");

            await recargarMetodos();
            await updateRatesForMetodo();
            compute();
        };

        pagoTabs.querySelectorAll(".tab-btn").forEach(btn =>
            btn.addEventListener("click", () => activar(pagoTabs, btn))
        );

        cobroTabs.querySelectorAll(".tab-btn").forEach(btn =>
            btn.addEventListener("click", () => activar(cobroTabs, btn))
        );
    }

    async function boot() {
        try {
            // Carga inicialmente las tasas de cambio seg√∫n los m√©todos de pago/cobro seleccionados
            await updateRatesForMetodo();

            // Construye las opciones de los selectores de monedas
            // Por defecto: "from" empieza con USD y "to" con PYG
            buildOptions(from, "USD");
            buildOptions(to, "PYG");

            // Asegura que origen y destino no sean iguales
            enforceDifferent(from, to);

            // Calcula inmediatamente la conversi√≥n con esos valores iniciales
            compute();
        } catch(e) {
            // Si algo falla (API, construcci√≥n de selects, etc.), muestra un error en consola
            console.error("No se pudieron cargar monedas:", e);
        }

        // Finalmente, recarga la lista de m√©todos de pago/cobro disponibles
        await recargarMetodos();
    }

    // Cuando el DOM est√° listo...
    document.addEventListener("DOMContentLoaded", async () => {
        // Conecta todos los listeners (inputs, selects, botones)
        attachListeners();

        // Primero carga los m√©todos de pago/cobro iniciales desde el backend
        await recargarMetodos();

        // Filtra los m√©todos de cobro y pago seg√∫n el tipo general seleccionado
        configurarTabsFiltro()

        // Ejecuta el arranque inicial (boot) para dejar todo preparado
        boot();
    });

    const hiddenInputs = {
        tipo: document.getElementById("input-tipo"),
        moneda_origen: document.getElementById("input-moneda-origen"),
        moneda_destino: document.getElementById("input-moneda-destino"),
        tasa_cambio: document.getElementById("input-tasa-cambio"),
        monto_origen: document.getElementById("input-monto-origen"),
        monto_destino: document.getElementById("input-monto-destino"),
        medio_pago_type: document.getElementById("input-medio-pago-type"),
        medio_pago_id: document.getElementById("input-medio-pago-id"),
        medio_cobro_type: document.getElementById("input-medio-cobro-type"),
        medio_cobro_id: document.getElementById("input-medio-cobro-id"),
    };

    document.querySelector("form").addEventListener("submit", function (e) {
        const montoOrigen = parseFloat(amount.value || "0");

        if (isNaN(montoOrigen) || montoOrigen <= 0) {
            e.preventDefault();  // Cancela el submit
            alert("Debes ingresar un monto v√°lido antes de confirmar la operaci√≥n");
            amount.focus();
            return;
        }

        const montoDestino = parseFloat(out.value.replace(/[^\d.,-]/g,"").replace(",",".")) || 0;
        const a = from.value, b = to.value;

        hiddenInputs.tipo.value = (a === "PYG" && b !== "PYG") ? "COMPRA" : "VENTA";
        hiddenInputs.moneda_origen.value = a;
        hiddenInputs.moneda_destino.value = b;
        hiddenInputs.monto_origen.value = montoOrigen;
        hiddenInputs.monto_destino.value = montoDestino;

        if (a === "PYG" && b !== "PYG") {
            hiddenInputs.tasa_cambio.value = 1 / META[b].venta;
        } else if (a !== "PYG" && b === "PYG") {
            hiddenInputs.tasa_cambio.value = META[a].compra;
        }

        if (metodoPago.options.length > 0) {
            hiddenInputs.medio_pago_id.value = metodoPago.value;
            hiddenInputs.medio_pago_type.value = metodoPago.selectedOptions[0].dataset.contentTypeId;
        }
        if (metodoCobro.options.length > 0) {
            hiddenInputs.medio_cobro_id.value = metodoCobro.value;
            hiddenInputs.medio_cobro_type.value = metodoCobro.selectedOptions[0].dataset.contentTypeId;
        }
    });
////////////////////////////////////////////////////////////////////////////////////////////////////////
//L√≥gica del Wizard
///////////////////////////////////////////////////////////////////////////////////////////////////////

    function mostrarMensaje(texto, tipo="error", duracion=5000) {
        // Busca el contenedor; si no existe, lo crea y lo agrega al body
        let container = document.getElementById("toast-container");
        console.log(container)
        if (!container) {
            container = document.createElement("div");
            container.id = "toast-container";
            container.style.position = "fixed";
            container.style.top = "1rem";
            container.style.right = "1rem";
            container.style.zIndex = 9999;
            container.style.display = "flex";
            container.style.flexDirection = "column";
            container.style.gap = "0.5rem";
            document.body.appendChild(container);
        }

        // Crear el mensaje
        const msg = document.createElement("div");
        msg.className = `toast-message ${tipo}`;
        msg.textContent = texto;
        msg.style.padding = "0.8rem 1rem";
        msg.style.borderRadius = "0.5rem";
        msg.style.color = "#fff";
        msg.style.backgroundColor = tipo === "error" ? "#e74c3c" : "#2ecc71";
        msg.style.boxShadow = "0 2px 6px rgba(0,0,0,0.2)";
        msg.style.opacity = 0;
        msg.style.transition = "opacity 0.3s";

        container.appendChild(msg);

        // Animaci√≥n de aparici√≥n
        requestAnimationFrame(() => { msg.style.opacity = 1; });

        // Desaparece despu√©s de 'duracion' ms
        setTimeout(() => {
            msg.style.opacity = 0;
            msg.addEventListener("transitionend", () => msg.remove());
        }, duracion);
    }

    document.addEventListener("DOMContentLoaded", () => {
        const step1 = document.getElementById("step-1");
        const step2 = document.getElementById("step-2");
        const next = document.getElementById("next-step");
        const prev = document.getElementById("prev-step");

        const ind1 = document.getElementById("indicator-step1");
        const ind2 = document.getElementById("indicator-step2");

        next.addEventListener("click", () => {
            // Actualiza los datos de resumen
            document.getElementById("resumen-tipo").textContent =
            document.getElementById("input-tipo")?.value || "";

            document.getElementById("resumen-origen").textContent =
            `${document.getElementById("input-monto-origen")?.value || "-"} ${document.getElementById("input-moneda-origen")?.value || ""}`;

            document.getElementById("resumen-destino").textContent =
            `${document.getElementById("input-monto-destino")?.value || "-"} ${document.getElementById("input-moneda-destino")?.value || ""}`;

            document.getElementById("resumen-pago").textContent =
            document.getElementById("simu-metodo-pago")?.selectedOptions[0]?.text || "-";

            document.getElementById("resumen-cobro").textContent =
            document.getElementById("simu-metodo-cobro")?.selectedOptions[0]?.text || "-";

            if (isNaN(amount.value) || amount.value <= 0) return mostrarMensaje("Monto inv√°lido.", "error");
            if (metodoPago.value === "") return mostrarMensaje("Selecciona un m√©todo de pago.", "error");
            if (metodoCobro.value === "") return mostrarMensaje("Selecciona un m√©todo de cobro.", "error");

            // Cambia la vista
            step1.classList.add("d-none");
            step2.classList.remove("d-none");
            ind1.classList.remove("active");
            ind2.classList.add("active");
        });

        prev.addEventListener("click", () => {
            // Volver al paso anterior
            step2.classList.add("d-none");
            step1.classList.remove("d-none");
            ind2.classList.remove("active");
            ind1.classList.add("active");
        });
    });

})();

</script>
{% endblock %}