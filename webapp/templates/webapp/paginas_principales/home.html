{% extends 'webapp/base.html' %}
{% load static %}
{% load permissions_tags %}
{% block title %}Global Exchange - Inicio{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'webapp/css/paginas_principales/home.css' %}?v=2.1">
{% endblock %}

{% block content %}

<!-- ===== NUEVA SECCIÓN: HERO BIENVENIDA + CARRUSEL ===== -->
{% if user.is_authenticated %}
<section class="hero-welcome-section">
    <div class="hero-welcome-container">
        <!-- Lado izquierdo: Título y subtítulo -->
        <div class="hero-left">
            <h1 class="hero-title">Un mundo de elecciones<br><span class="hero-title-accent">con Global Exchange</span></h1>
            <p class="hero-subtitle">¡Visitanos en nuestras sucursales!</p>
        </div>
        
        <!-- Lado derecho: Bienvenida del usuario -->
        <div class="hero-right">
            <p class="hero-welcome-user">
                ¡BIENVENIDO/A <span class="user-highlight">{{ user.get_full_name|default:user.username|upper }}</span>!
            </p>
            {% if current_client %}
                <p class="hero-client-info">
                    Actualmente está operando con <span class="client-highlight">{{ current_client.nombre|upper }}</span>
                </p>
            {% else %}
                <p class="hero-client-info">
                    <span class="hero-no-client">No hay cliente seleccionado</span>
                </p>
            {% endif %}
        </div>
    </div>
</section>
{% else %}
<!-- Hero público para visitantes no autenticados (centrado, sin CTA) -->
<section class="hero-welcome-section hero-guest">
    <div class="hero-welcome-container">
        <div class="hero-left">
            <h1 class="hero-title">Un mundo de elecciones<br><span class="hero-title-accent">con Global Exchange</span></h1>
            <p class="hero-subtitle">¡Visitanos en nuestras sucursales!</p>
        </div>
    </div>
</section>
{% endif %}

<!-- Carrusel de Sucursales (visible para todo público) -->
<section class="branches-carousel-section">
    <div class="branches-carousel-wrapper">
        <!-- Botón anterior -->
        <button class="carousel-nav-btn carousel-prev" id="carousel-prev" aria-label="Sucursal anterior">
            <img src="{% static 'webapp/pantalla_sucursales/tick-izquierda.png' %}" alt="Anterior">
        </button>
        
        <!-- Contenedor del carrusel -->
        <div class="branches-carousel-container">
            <div class="branches-carousel-track" id="carousel-track">
                <!-- Sucursal 1: Casa Central -->
                <div class="branch-slide">
                    <img src="{% static 'webapp/pantalla_sucursales/1.CasaCentral.png' %}" alt="Casa Central" class="branch-image">
                    <div class="branch-overlay">
                        <p class="branch-name">Sucursal Casa Central</p>
                    </div>
                </div>
                
                <!-- Sucursal 2: Shopping Pinedo -->
                <div class="branch-slide">
                    <img src="{% static 'webapp/pantalla_sucursales/2.Pinedo.png' %}" alt="Shopping Pinedo" class="branch-image">
                    <div class="branch-overlay">
                        <p class="branch-name">Sucursal Shopping Pinedo</p>
                    </div>
                </div>
                
                <!-- Sucursal 3: Shopping Villa Morra -->
                <div class="branch-slide">
                    <img src="{% static 'webapp/pantalla_sucursales/3.VillaMorra.png' %}" alt="Shopping Villa Morra" class="branch-image">
                    <div class="branch-overlay">
                        <p class="branch-name">Sucursal Shopping Villa Morra</p>
                    </div>
                </div>
                
                <!-- Sucursal 4: Shopping Multiplaza -->
                <div class="branch-slide">
                    <img src="{% static 'webapp/pantalla_sucursales/4.Multiplaza.png' %}" alt="Shopping Multiplaza" class="branch-image">
                    <div class="branch-overlay">
                        <p class="branch-name">Sucursal Shopping Multiplaza</p>
                    </div>
                </div>
                
                <!-- Sucursal 5: Mariano Roque Alonso -->
                <div class="branch-slide">
                    <img src="{% static 'webapp/pantalla_sucursales/5.MarianoRoqueAlonso.png' %}" alt="Mariano Roque Alonso" class="branch-image">
                    <div class="branch-overlay">
                        <p class="branch-name">Sucursal Mariano Roque Alonso</p>
                    </div>
                </div>
                
                <!-- Sucursal 6: Ciudad del Este -->
                <div class="branch-slide">
                    <img src="{% static 'webapp/pantalla_sucursales/6.CiudadDelEste.png' %}" alt="Ciudad del Este" class="branch-image">
                    <div class="branch-overlay">
                        <p class="branch-name">Sucursal Ciudad del Este</p>
                    </div>
                </div>
                
                <!-- Sucursal 7: Encarnación -->
                <div class="branch-slide">
                    <img src="{% static 'webapp/pantalla_sucursales/7.Encarnacion.png' %}" alt="Encarnación" class="branch-image">
                    <div class="branch-overlay">
                        <p class="branch-name">Sucursal Encarnación</p>
                    </div>
                </div>
                
                <!-- Sucursal 8: Itauguá -->
                <div class="branch-slide">
                    <img src="{% static 'webapp/pantalla_sucursales/9.Itaugua.png' %}" alt="Itauguá" class="branch-image">
                    <div class="branch-overlay">
                        <p class="branch-name">Sucursal Itauguá</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Botón siguiente -->
        <button class="carousel-nav-btn carousel-next" id="carousel-next" aria-label="Sucursal siguiente">
            <img src="{% static 'webapp/pantalla_sucursales/tick-derecha.png' %}" alt="Siguiente">
        </button>
    </div>
</section>

<!-- ===== SECCIÓN ORIGINAL: TABLA DE COTIZACIONES Y CONVERSOR ===== -->

<div class="main-home-container">
    <div class="main-content-row">

        <!-- Left: Rates Table -->
        <div class="rates-section">
            <div class="rates-container">
                <div class="rates-header">
                    <div class="date-display">
                        {% if last_update %}
                            Fecha: {{ last_update|date:"d/m/Y H:i" }}
                        {% else %}
                            Fecha: No disponible
                        {% endif %}
                    </div>
                    <button id="refresh-btn" onclick="refreshRates()" class="refresh-button" title="Actualizar cotizaciones">
                        <img src="{% static 'webapp/home/actualizar.png' %}" alt="Actualizar" class="refresh-icon">
                    </button>
                </div>
                <div class="rates-table-container">
                    <table class="rates-table">
                        <thead>
                            <tr>
                                <th>Moneda</th>
                                <th>Compra</th>
                                <th>Venta</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for currency in currencies %}
                                {% if currency.code != 'PYG' %}
                                    <tr>
                                        <td class="currency-cell">
                                            {% if currency.flag_image %}
                                                <img src="{{ currency.flag_image.url }}" alt="{{ currency.name }}" class="currency-flag">
                                            {% endif %}
                                            <span class="currency-name">{{ currency.name }}</span>
                                        </td>
                                        <td class="rate-cell">{{ currency.totalCompra|floatformat:0 }} PYG</td>
                                        <td class="rate-cell">{{ currency.totalVenta|floatformat:0 }} PYG</td>
                                    </tr>
                                {% endif %}
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Right: Currency Converter -->
        <div class="converter-section">
            <div class="converter-container">
                <h2 class="converter-title">
                    <span class="yellow-text">Conversor de</span> <span class="white-text">moneda</span>
                </h2>
                <p class="converter-subtitle">Selecciona la moneda y el monto de cotización</p>
                
                <div class="converter-form">
                    <!-- From Currency -->
                    <div class="converter-field">
                        <label class="field-label">Tengo esta moneda</label>
                        <div class="field-row">
                            <div class="select-wrapper">
                                <select id="simu-from" class="currency-select"></select>
                                <img src="{% static 'webapp/home/tick.png' %}" alt="dropdown" class="select-arrow">
                            </div>
                            <input id="simu-amount" type="number" step="0.01" min="0" class="amount-input">
                        </div>
                    </div>

                    <!-- To Currency -->
                    <div class="converter-field">
                        <label class="field-label">Quiero esta moneda</label>
                        <div class="field-row">
                            <div class="select-wrapper">
                                <select id="simu-to" class="currency-select"></select>
                                <img src="{% static 'webapp/home/tick.png' %}" alt="dropdown" class="select-arrow">
                            </div>
                            <input type="text" readonly class="result-input" id="simu-result-main">
                        </div>
                    </div>
                    
                    <div class="converter-actions">
                        <button id="simu-intercambiar" type="button" class="intercambiar-button">INTERCAMBIAR</button>
                    </div>

                    <div class="converter-result">
                        <p id="simu-result-detail" class="result-detail">Ingresá un monto para calcular</p>
                    </div>

                    <div class="reference-text">
                        {% if categoria_cliente %}
                            <p>Cotización exclusiva para la categoria: {{categoria_cliente.nombre|upper}}</p>
                        {% else %}
                            <p>SIN CATEGORÍA</p>
                        {% endif %}
                        <p>*Última actualización: {% if last_update %} {{ last_update|date:"d/m/Y H:i" }} {% else %} Fecha: No disponible {% endif %} - Cotizaciones meramente de referencia.</p>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>


<script>
function refreshRates() {
    const btn = document.getElementById('refresh-btn');
    btn.classList.add('loading');
    btn.innerHTML = '⏳';
    btn.disabled = true;
    setTimeout(() => location.reload(), 500);
}

(async function() {
    const amount = document.getElementById("simu-amount");
    const from = document.getElementById("simu-from");
    const to = document.getElementById("simu-to");
    const intercambiar = document.getElementById("simu-intercambiar");
    const out = document.getElementById("simu-result-main");
    const detail = document.getElementById("simu-result-detail");
    const metodoPago = document.getElementById("simu-metodo-pago");
    const metodoCobro = document.getElementById("simu-metodo-cobro");

    let CODES = [];
    const META = Object.create(null);

    function nf(value, currencyCode) {
        const decimals = currencyCode === "PYG" ? 0 : (META[currencyCode]?.decimals ?? 2);
        return new Intl.NumberFormat("es-ES", {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        }).format(value);
    }

    function buildOptions(selectEl, preferCode) {
        selectEl.innerHTML = "";
        CODES.forEach(code => {
            const opt = document.createElement("option");
            opt.value = code;
            const name = META[code]?.name || code;
            if (code === "USD") opt.textContent = "DÓLAR";
            else if (code === "PYG") opt.textContent = "GUARANÍ";
            else if (code === "EUR") opt.textContent = "EURO";
            else opt.textContent = name.toUpperCase();
            selectEl.appendChild(opt);
        });
        if (preferCode && CODES.includes(preferCode)) selectEl.value = preferCode;
        else if (CODES.length) selectEl.value = CODES[0];
    }

    function enforceDifferent(changed, other) {
        // Caso 1: si el usuario pone PYG en ambos
        if (from.value === "PYG" && to.value === "PYG") {
            // fijamos que el "otro" se quede en USD (si existe) en vez de tomar el primero al azar
            const fallback = CODES.includes("USD") ? "USD" : CODES.find(c => c !== "PYG");
            if (changed === from) to.value = fallback;
            else from.value = fallback;
        }

        // Caso 2: si el usuario pone la misma moneda en ambos (pero no es PYG)
        else if (from.value === to.value) {
            // el otro se fuerza a PYG
            if (changed === from) to.value = "PYG";
            else from.value = "PYG";
        }

        // Caso 3: si ninguno es PYG
        if (from.value !== "PYG" && to.value !== "PYG") {
            // el que no cambió se fuerza a PYG
            if (changed === from) to.value = "PYG";
            else from.value = "PYG";
        }
    }

    function compute() {
        const raw = parseFloat((amount.value || "").toString().replace(",", "."));
        if (isNaN(raw) || raw <= 0) {
            out.value = "";
            detail.textContent = "Ingresá un monto para calcular";
            return;
        }
        const a = from.value, b = to.value;
        if (!META[a] || !META[b]) return;

        let val, rateAB;

        if (a === "PYG" && b !== "PYG") {
            val = raw / META[b].venta;
            rateAB = 1 / META[b].venta;
            detail.innerHTML = `1 ${a} = ${nf(rateAB, b)} ${b}`;
        } 
        else if (a !== "PYG" && b === "PYG") {
            val = raw * META[a].compra;
            rateAB = META[a].compra;
            detail.innerHTML = `1 ${a} = ${nf(rateAB, "PYG")} ${b}`;
        } 
        else {
            out.value = "";
            detail.textContent = "Sólo se permiten conversiones con Guaraníes";
            return;
        }

        out.value = `${nf(val, b)} ${b}`;
    }

    function attachListeners() {
        ["input","change"].forEach(evt => {
            amount.addEventListener(evt, compute);
            from.addEventListener(evt, () => { enforceDifferent(from,to); compute(); });
            to.addEventListener(evt, () => { enforceDifferent(to,from); compute(); });
        });

        intercambiar.addEventListener("click", () => {
            const tmp = from.value; from.value = to.value; to.value = tmp;
            enforceDifferent(from,to); compute();
        });

        if (metodoPago && metodoCobro) {
            [metodoPago, metodoCobro].forEach(el => el.addEventListener("change", updateRatesForMetodo));
        }
    }

    async function updateRatesForMetodo() {
        try {
            if (!metodoPago || !metodoCobro) return;
            const url = `{% url 'api_currencies' %}?metodo_pago_id=${metodoPago.value}&metodo_cobro_id=${metodoCobro.value}`;
            const res = await fetch(url, { cache:"no-store" });
            const payload = await res.json();
            const items = payload.items || [];
            const byCode = {};
            items.forEach(it => byCode[it.code] = it);
            if (!byCode["PYG"]) byCode["PYG"] = { code:"PYG", name:"Guaraní", decimals:0, venta:1.0, compra:1.0 };
            CODES = Object.keys(byCode).sort((a,b)=> a==="PYG"?-1:b==="PYG"?1:a.localeCompare(b));
            CODES.forEach(code=>META[code]=byCode[code]);
            // Solo recalcula, no reconstruye select de monedas
            compute();
        } catch(e) {
            console.error("Error al actualizar tasas:", e);
        }
    }

    async function recargarMetodos() {
        if (!metodoPago || !metodoCobro) return; // no existen selects

        try {
            const res = await fetch("{% url 'get_metodos_pago_cobro' %}");
            const data = await res.json();

            if (metodoPago.options.length === 0) {
                data.tipos_pago.forEach(item => {
                    const opt = document.createElement("option");
                    opt.value = item.id;
                    opt.textContent = item.nombre;
                    if (item.nombre.toLowerCase() === "tauser") opt.selected = true;
                    metodoPago.appendChild(opt);
                });
            }

            if (metodoCobro.options.length === 0) {
                data.tipos_cobro.forEach(item => {
                    const opt = document.createElement("option");
                    opt.value = item.id;
                    opt.textContent = item.nombre;
                    if (item.nombre.toLowerCase() === "tauser") opt.selected = true;
                    metodoCobro.appendChild(opt);
                });
            }
        } catch(error) {
            console.error("Error al cargar métodos de pago/cobro:", error);
        }
    }

    async function boot() {
        try {
            let url = "{% url 'api_currencies' %}";
            if (metodoPago && metodoCobro) {
                url += `?metodo_pago_id=${metodoPago.value}&metodo_cobro_id=${metodoCobro.value}`;
            }

            const res = await fetch(url, { cache:"no-store" });
            const payload = await res.json();
            const items = payload.items || [];
            const byCode = {};
            items.forEach(it => { byCode[it.code] = it; });

            if (!byCode["PYG"]) byCode["PYG"] = { code:"PYG", name:"Guaraní", decimals:0, venta:1.0, compra:1.0 };

            CODES = Object.keys(byCode).sort((a,b)=> a==="PYG"?-1:b==="PYG"?1:a.localeCompare(b));
            CODES.forEach(code=>META[code]=byCode[code]);

            buildOptions(from,"USD");
            buildOptions(to,"PYG");
            enforceDifferent(from,to);
            compute();
        } catch(e) {
            console.error("No se pudieron cargar monedas:", e);
        }
    }

    document.addEventListener("DOMContentLoaded", async () => {
        await recargarMetodos();
        attachListeners();
        boot();
    });

})();

// ===== CARRUSEL DE SUCURSALES =====
(function() {
    const track = document.getElementById('carousel-track');
    const prevBtn = document.getElementById('carousel-prev');
    const nextBtn = document.getElementById('carousel-next');
    
    if (!track || !prevBtn || !nextBtn) return; // No existe el carrusel (usuario no autenticado)
    
    const slides = track.querySelectorAll('.branch-slide');
    const slideCount = slides.length;
    
    if (slideCount === 0) return;
    
    // Configuración
    const slideWidth = 424; // Ancho de cada slide
    const slideGap = 20; // Gap entre slides
    const slidesToShow = 3; // Cuántos slides mostrar a la vez
    const autoPlayInterval = 5000; // 5 segundos para autoplay
    
    let currentIndex = 0;
    let autoPlayTimer = null;
    
    // Calcular el máximo índice permitido
    const maxIndex = Math.max(0, slideCount - slidesToShow);
    
    function updateCarousel() {
        const offset = currentIndex * (slideWidth + slideGap);
        track.style.transform = `translateX(-${offset}px)`;
        
        // Actualizar estado de los botones
        prevBtn.disabled = currentIndex === 0;
        nextBtn.disabled = currentIndex >= maxIndex;
    }
    
    function goToNext() {
        if (currentIndex < maxIndex) {
            currentIndex++;
        } else {
            currentIndex = 0; // Loop back to start
        }
        updateCarousel();
    }
    
    function goToPrev() {
        if (currentIndex > 0) {
            currentIndex--;
        } else {
            currentIndex = maxIndex; // Loop to end
        }
        updateCarousel();
    }
    
    // Event listeners para los botones
    nextBtn.addEventListener('click', () => {
        goToNext();
        resetAutoPlay();
    });
    
    prevBtn.addEventListener('click', () => {
        goToPrev();
        resetAutoPlay();
    });
    
    // AutoPlay
    function startAutoPlay() {
        autoPlayTimer = setInterval(goToNext, autoPlayInterval);
    }
    
    function resetAutoPlay() {
        clearInterval(autoPlayTimer);
        startAutoPlay();
    }
    
    // Pausar autoplay cuando el mouse está sobre el carrusel
    track.addEventListener('mouseenter', () => {
        clearInterval(autoPlayTimer);
    });
    
    track.addEventListener('mouseleave', () => {
        startAutoPlay();
    });
    
    // Inicializar
    updateCarousel();
    startAutoPlay();
})();

</script>

{% endblock %}
