{% extends 'webapp/base.html' %}

{% load static %}

{% load permissions_tags %}

{% block title %}Panel de Administración{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'webapp/css/dashboards/admin.css' %}?v=2.2" />
<link rel="stylesheet" href="{% static 'webapp/css/dashboards/user_dashboard.css' %}" />
{% endblock %}

{% block content %}
{% has_perms request.user 'webapp.access_admin_panel' as can_access_admin_panel %}
{% has_perms request.user 'webapp.access_analyst_panel' as can_access_analyst_panel %}

{# Permisos que usaremos para decidir si mostramos contenedores #}
{% has_perms request.user 'webapp.view_currency' as p_view_currency %}
{% has_perms request.user 'webapp.view_limiteintercambio' as p_view_lim %}
{% has_perms request.user 'webapp.view_mediopago' as p_view_mediopago %}
{% has_perms request.user 'webapp.view_mediocobro' as p_view_mediocobro %}
{% has_perms request.user 'webapp.view_emailscheduleconfig' as p_view_emailscheduleconfig %}
{% has_perms request.user 'webapp.view_limiteintercambioscheduleconfig' as p_view_limiteintercambioscheduleconfig %}
{% has_perms request.user 'webapp.view_expiraciontransaccionconfig' as p_view_expiraciontransaccionconfig %}


{% if can_access_admin_panel or can_access_analyst_panel %}
<div class="admin-panel">
    <!-- Header Section -->
    <div class="admin-header">
        <h1 class="admin-title">
            {% if can_access_admin_panel %}
                Panel de administración
            {% else %}
                Panel de Analista
            {% endif %}
        </h1>
        <p class="admin-subtitle">
            {% if can_access_admin_panel %}
                Gestión centralizada del sistema Global Exchange
            {% else %}
                Gestiones habilitadas para Analista
            {% endif %}
        </p>
    </div>

    <!-- Metrics Section -->
    <div class="admin-metrics">
        {% if can_access_admin_panel %}
        <div class="metric-card">
            <div class="metric-label">Usuarios Activos</div>
            <div class="metric-number">{{ usuarios_activos }}</div>
        </div>
        <div class="metric-card">
            <div class="metric-label">Clientes Activos</div>
            <div class="metric-number">{{ clientes_activos }}</div>
        </div>
        {% endif %}

        {% if can_access_admin_panel or p_view_currency %}
        <div class="metric-card">
            <div class="metric-label">Monedas Activas</div>
            <div class="metric-number">{{ monedas_activas }}</div>
        </div>
        {% endif %}

        {% if can_access_admin_panel %}
        <div class="metric-card">
            <div class="metric-label">Entidades Activas</div>
            <div class="metric-number">{{ entidades_activas }}</div>
        </div>
        {% endif %}
    </div>

    <!-- Management Containers Grid -->
    <div class="admin-containers-grid">
        {% if can_access_admin_panel %}
        <!-- Contenedor 1: Gestión de Usuarios y Roles -->
        <div class="management-container usuarios-roles-container">
            <h2 class="container-title">Gestión de Usuarios y Roles</h2>
            
            {% has_perms request.user 'webapp.view_customuser' as can_view_customuser %}
            {% if can_view_customuser %}
            <a href="{% url 'manage_users' %}" class="management-button">
                <img src="{% static 'webapp/panel_gestiones/1.Administar_Usuarios.png' %}" alt="Administrar Usuarios" class="button-icon">
                <span class="button-text">Administrar Usuarios</span>
            </a>
            {% endif %}
            
            {% has_perms request.user 'webapp.view_role' as can_view_role %}
            {% if can_view_role %}
            <a href="{% url 'manage_roles' %}" class="management-button">
                <img src="{% static 'webapp/panel_gestiones/2.Administrar_Roles.png' %}" alt="Administrar Roles" class="button-icon">
                <span class="button-text">Administrar Roles</span>
            </a>
            {% endif %}
            
            {% has_perms request.user 'webapp.view_customuser' 'webapp.view_role' as can_view_customuser_role %}
            {% if can_view_customuser_role %}
            <a href="{% url 'manage_user_roles' %}" class="management-button">
                <img src="{% static 'webapp/panel_gestiones/3.Administar_Roles_de_Usuarios.png' %}" alt="Administrar Roles de Usuarios" class="button-icon">
                <span class="button-text">Administrar Roles de Usuarios</span>
            </a>
            {% endif %}
        </div>
        {% endif %}


        {% if can_access_admin_panel %}
        <!-- Contenedor 2: Gestión de Clientes y Categorías -->
        <div class="management-container clientes-categorias-container">
            <h2 class="container-title">Gestión de Clientes y Categorías</h2>
            
            {% has_perms request.user 'webapp.view_cliente' as can_view_cliente %}
            {% if can_view_cliente %}
            <a href="{% url 'manage_clientes' %}" class="management-button">
                <img src="{% static 'webapp/panel_gestiones/5.Administrar_Clientes.png' %}" alt="Administrar Clientes" class="button-icon">
                <span class="button-text">Administrar Clientes</span>
            </a>
            {% endif %}
            
            {% has_perms request.user 'webapp.view_clienteusuario' as can_view_clienteusuario %}
            {% if can_view_clienteusuario %}
            <a href="{% url 'assign_clients' %}" class="management-button">
                <img src="{% static 'webapp/panel_gestiones/4.Asignar_Clientes_a_Usuarios.png' %}" alt="Asignar Clientes a Usuarios" class="button-icon">
                <span class="button-text">Asignar Clientes a Usuarios</span>
            </a>
            {% endif %}
            
            {% has_perms request.user 'webapp.view_categoria' as can_view_categoria %}
            {% if can_view_categoria %}
            <a href="{% url 'manage_categories' %}" class="management-button">
                <img src="{% static 'webapp/panel_gestiones/7.Administrar_Categorias.png' %}" alt="Administrar Categorías" class="button-icon">
                <span class="button-text">Administrar Categorías</span>
            </a>
            {% endif %}
        </div>
        {% endif %}

        {% if can_access_admin_panel or p_view_currency or p_view_lim %}
        <!-- Contenedor 3: Gestión de Monedas y Cotizaciones -->
        <div class="management-container monedas-cotizaciones-container">
            <h2 class="container-title">Gestión de Monedas y Cotizaciones</h2>
            
            {% has_perms request.user 'webapp.view_currency' as can_view_currency %}
            {% if can_access_admin_panel %}
            <a href="{% url 'manage_currencies' %}" class="management-button">
                <img src="{% static 'webapp/panel_gestiones/6.Administrar_Monedas.png' %}" alt="Administrar Monedas" class="button-icon">
                <span class="button-text">Administrar Monedas</span>
            </a>
            {% endif %}
            
            {% has_perms request.user 'webapp.view_currency' as can_view_currency %}
            {% if can_view_currency %}
            <a href="{% url 'manage_quotes' %}" class="management-button">
                <img src="{% static 'webapp/panel_gestiones/8.Administrar_Cotizaciones.png' %}" alt="Administrar Cotizaciones" class="button-icon">
                <span class="button-text">Administrar Cotizaciones</span>
            </a>
            {% endif %}
            
            {% has_perms request.user 'webapp.view_limiteintercambioconfig' as can_view_limiteintercambio %}
            {% if can_view_limiteintercambio %}
            <a href="{% url 'limites_list' %}" class="management-button">
                <img src="{% static 'webapp/panel_gestiones/13. Administrar_Limites_de_Intercambio.png' %}" alt="Administrar Límites de Intercambio" class="button-icon">
                <span class="button-text">Administrar Límites de Intercambio</span>
            </a>
            {% endif %}

        </div>
        {% endif %}

        {% if can_access_admin_panel or p_view_mediopago or p_view_mediocobro %}
        <!-- Contenedor 4: Gestión de Métodos de Pago -->
        <div class="management-container metodos-pago-container">
            <h2 class="container-title">Gestión de Métodos de Pago</h2>
            
            {% has_perms request.user 'webapp.view_mediopago' as can_view_mediopago %}
            {% if can_view_mediopago %}
            <a href="{% url 'manage_payment_methods' %}" class="management-button">
                <img src="{% static 'webapp/panel_gestiones/9.Administrar_Metodos_de_Pago.png' %}" alt="Administrar Métodos de Pago Globales" class="button-icon">
                <span class="button-text">Administrar Métodos de Pago Globales</span>
            </a>
            {% endif %}
            
            {% has_perms request.user 'webapp.view_mediocobro' as can_view_mediocobro %}
            {% if can_view_mediocobro %}
            <a href="{% url 'manage_cobro_methods' %}" class="management-button">
                <img src="{% static 'webapp/panel_gestiones/11.Administrar_Metodos_de_Cobro.png' %}" alt="Administrar Métodos de Cobro Globales" class="button-icon">
                <span class="button-text">Administrar Métodos de Cobro Globales</span>
            </a>
            {% endif %}
            
            {% if can_access_admin_panel %}
            <a href="{% url 'entidad_list' %}" class="management-button long-text-button">
                <img src="{% static 'webapp/panel_gestiones/14.Administrar_Entidades.png' %}" alt="Administrar Entidades de Pago/Cobro" class="button-icon">
                <span class="button-text">Administrar Entidades de Pago/Cobro</span>
            </a>
            {% endif %}
        </div>
        {% endif %}

        {% if can_access_admin_panel or p_view_emailscheduleconfig or p_view_expiraciontransaccionconfig or p_view_limiteintercambioscheduleconfig %}
        <!-- Contenedor 5: Gestión de Temporizadores -->
        <div class="management-container configuracion-global-container">
            <h2 class="container-title">Configuraciones Globales</h2>
            <a href="{% url 'manage_schedule' %}" class="management-button long-text-button">
                <img src="{% static 'webapp/panel_gestiones/15.Administrar_Temporizadores.png' %}" alt="Administrar Temporizadores" class="button-icon">
                <span class="button-text">Administrar Temporizadores</span>
            </a>
        </div>
        {% endif %}

    </div>
</div>
{% else %}
<div class="user-dashboard-container">
    {# Header de bienvenida retirado por solicitud #}

    <!-- Main Content -->
    <div class="main-content">
        {% is_usuario_asociado request.user as usuario_asociado %}
        {% if usuario_asociado %}
        {# Se removió la sección de Métodos de Pago y Cobro y el CTA del landing. Página independiente: /administar-metodos-pago/ #}
        {% else %}
        <!-- No Associated User Message -->
        <div class="no-access-section">
            <div class="no-access-content">
                <div class="no-access-icon">
                    <img src="{% static 'webapp/panel_gestiones/1.Administar_Usuarios.png' %}" alt="Sin Acceso">
                </div>
                <h2 class="no-access-title">No tienes acceso a funciones de usuario</h2>
                <p class="no-access-description">Contacta con un administrador para obtener acceso a las funciones de gestión de métodos de pago y cobro.</p>
                <a href="{% url 'public_home' %}" class="no-access-btn">Volver al Inicio</a>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endif %}
{% endblock %}
