{% extends 'webapp/base.html' %}
{% load static %}
{% block title %}Global Exchange - Histórico{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'webapp/historical.css' %}">
{% endblock %}

{% block content %}
<div class="main-home-container">
    <h2 class="historical-title">Histórico de monedas</h2>

    <div class="currency-selector">
        <label for="history-currency">Seleccionar moneda:</label>
        <select id="history-currency"></select>
    </div>

    <div class="range-buttons">
        <button class="btn-range" data-range="week">Semana</button>
        <button class="btn-range" data-range="month">Mes</button>
        <button class="btn-range" data-range="6months">6 Meses</button>
        <button class="btn-range" data-range="year">Año</button>
    </div>


    <canvas id="historyChart" height="120"></canvas>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
(async function(){
  const ctx = document.getElementById('historyChart').getContext('2d');
  let chart;

  async function loadCurrencies() {
    const res = await fetch("{% url 'api_active_currencies' %}");
    const payload = await res.json();
    const select = document.getElementById("history-currency");
    select.innerHTML = "";
    payload.items.forEach(item => {
      const opt = document.createElement("option");
      opt.value = item.code;
      opt.textContent = item.name;
      select.appendChild(opt);
    });
  }

  async function loadHistory(code="USD", range="week") {
    const res = await fetch(`{% url 'api_currency_history' %}?code=${code}&range=${range}`);
    const payload = await res.json();
    const labels = payload.items.map(i => i.date);
    const compra = payload.items.map(i => i.compra);
    const venta = payload.items.map(i => i.venta);

    if (chart) chart.destroy();
    chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels,
            datasets: [
            {
                label: 'Compra',
                data: compra,
                borderColor: '#28a745',
                backgroundColor: 'rgba(40,167,69,0.25)',
                tension: 0.4,
                fill: true,
                pointRadius: 4,
                pointHoverRadius: 6,
                pointBackgroundColor: '#28a745',
                pointBorderColor: '#fff'
            },
            {
                label: 'Venta',
                data: venta,
                borderColor: '#ffb300',
                backgroundColor: 'rgba(255,179,0,0.25)',
                tension: 0.4,
                fill: true,
                pointRadius: 4,
                pointHoverRadius: 6,
                pointBackgroundColor: '#ffb300',
                pointBorderColor: '#fff'
            }
            ]
        },
        options: {
            responsive: true,
            plugins: {
            legend: {
                labels: {
                color: '#fff',
                font: { size: 14, weight: 'bold', family: 'Roboto' }
                }
            }
            },
            scales: {
            x: {
                ticks: {
                color: '#fff',
                font: { family: 'Roboto', size: 12 }
                },
                grid: { color: 'rgba(255,255,255,0.1)' }
            },
            y: {
                ticks: {
                color: '#fff',
                font: { family: 'Roboto', size: 12 }
                },
                grid: { color: 'rgba(255,255,255,0.1)' }
            }
            }
        }
    });
  }

  // Eventos
  document.querySelectorAll(".range-buttons button").forEach(btn => {
    btn.addEventListener("click", ()=>{
      const code = document.getElementById("history-currency").value;
      loadHistory(code, btn.dataset.range);
    });
  });

  document.getElementById("history-currency").addEventListener("change", (e)=>{
    loadHistory(e.target.value, "week");
  });

  // Boot
  await loadCurrencies();
  const defaultCode = document.getElementById("history-currency").value;
  loadHistory(defaultCode, "week");
})();
</script>
{% endblock %}
