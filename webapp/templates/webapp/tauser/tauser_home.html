{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'webapp/css/tauser/tauser_home.css' %}?v=5.3">
{% endblock %}

{% block content %}

<!-- Header Section -->
<div class="transactions-header">
    <div class="header-content">
        <a href="{% url 'public_home' %}" class="back-button">← Volver a Inicio</a>
        <h1 class="transactions-title">Tauser - {{ ubicacion }}</h1>
        <p class="transactions-subtitle">Paga, cobra lo que te corresponde a través de nuestro servicio de tauser</p>
    </div>
</div>

<!-- Main Content -->
<div class="main-content">
    <!-- Transactions List Container -->
    <div class="transactions-list-container">
        <div class="transactions-list-header">
            <h2 class="list-title">Lista de Transacciones</h2>
            <div class="search-container">
                <input type="text" class="search-input" placeholder="Buscar Transacción" id="searchInput">
            </div>
        </div>
        
        <!-- Transactions Table -->
        <div class="transactions-table-container">
            <table class="transactions-table">
                <thead>
                    <tr>
                        <th>Transacción</th>
                        <th>Estado</th>
                        <th>Fecha de creación</th>
                        <th>Fecha de pago</th>
                        <th>Cliente</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
                    {% for transaccion in transacciones %}
                    <tr data-user-name="{{ transaccion.usuario.username }}" 
                        data-user-fullname="{{ transaccion.usuario.get_full_name }}" 
                        data-client-document="{{ transaccion.cliente.documento }}"
                        data-origin-currency="{{ transaccion.moneda_origen.code }}"
                        data-dest-currency="{{ transaccion.moneda_destino.code }}"
                        data-origin-currency-name="{{ transaccion.moneda_origen.name }}"
                        data-dest-currency-name="{{ transaccion.moneda_destino.name }}"
                        data-exchange-rate="{{ transaccion.tasa_cambio }}"
                        data-origin-amount="{{ transaccion.monto_origen }}"
                        data-dest-amount="{{ transaccion.monto_destino }}"
                        data-payment-method="{{ transaccion.medio_pago }}"
                        data-collection-method="{{ transaccion.medio_cobro }}">
                        <td class="transaction-type">
                            {% if transaccion.tipo == 'COMPRA' %}
                                Compra {{ transaccion.moneda_destino.code }}
                            {% else %}
                                Venta {{ transaccion.moneda_origen.code }}
                            {% endif %}
                        </td>
                        <td class="status-cell">
                            <div class="status-indicator {{ transaccion.estado|lower }}"></div>
                            <span class="status-text">{{ transaccion.get_estado_display }}</span>
                        </td>
                        <td class="creation-date">{{ transaccion.fecha_creacion|date:"d-m-y" }}</td>
                        <td class="payment-date">
                            {% if transaccion.fecha_pago %}
                                {{ transaccion.fecha_pago|date:"d-m-y" }}
                            {% else %}
                                -
                            {% endif %}
                        </td>
                        <td class="client-name">{{ transaccion.cliente.nombre }}</td>
                        <td class="actions-cell">
                            <!-- Botón "Ver Datos" siempre visible -->
                            {% if transaccion.cambio_pendiente and transaccion.estado == 'PENDIENTE' and transaccion.monto_origen_nuevo_fmt %}
                                <button
                                    class="action-button view-change-btn"
                                    data-transaction-id="{{ transaccion.id }}"
                                    data-moneda-code="{{ transaccion.moneda_cambio_code }}"
                                    data-tasa-anterior="{{ transaccion.tasa_antigua }}"
                                    data-tasa-actual="{{ transaccion.tasa_actual }}"
                                    data-monto-origen-anterior="{{ transaccion.monto_origen_actual_fmt }} {{ transaccion.moneda_origen.code }}"
                                    data-monto-destino-anterior="{{ transaccion.monto_destino_actual_fmt }} {{ transaccion.moneda_destino.code }}"
                                    data-monto-origen-nuevo="{{ transaccion.monto_origen_nuevo_fmt }} {{ transaccion.moneda_origen.code }}"
                                    data-monto-destino-nuevo="{{ transaccion.monto_destino_nuevo_fmt }} {{ transaccion.moneda_destino.code }}"
                                    data-url-aceptar="{% url 'transaccion_aceptar_cambio' transaccion.id %}"
                                    data-url-cancelar="{% url 'cancelar_transaccion' transaccion.id %}"
                                >
                                    Ver Cambios
                                </button>
                            {% else %}
                                <button class="action-button view-data-btn"
                                        data-transaction-id="{{ transaccion.id }}">
                                    Ver Datos
                                </button>
                            {% endif %}
                            <!-- Mostrar botón PAGAR si el medio de pago es Tauser -->
                            {% if transaccion.es_pago_tauser and transaccion.estado == 'PENDIENTE' %}
                                {% if not transaccion.cambio_pendiente %}
                                    <a href="{% url 'tauser_pagar' transaccion.id %}" class="action-button pagar-btn">
                                        Pagar
                                    </a>
                                {% endif %}
                            {% endif %}
                            <!-- Mostrar botón COBRAR si el medio de cobro es Tauser -->
                            {% if transaccion.es_cobro_tauser and transaccion.estado == 'PAGADA' %}
                                <a href="{% url 'tauser_cobrar' transaccion.id %}" class="action-button cobrar-btn">
                                    Cobrar
                                </a>
                            {% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="6" class="no-transactions">No hay transacciones registradas.</td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal para Ver Datos de Transacción -->
<div id="transactionModal" class="modal-overlay">
    <div class="modal-container">
        <div class="modal-header">
            <img src="{% static 'webapp/logo.png' %}" alt="Logo" class="modal-logo">
            <h2 class="modal-title">Datos de Transacción</h2>
        </div>
        <div class="modal-separator"></div>
        <div class="modal-content">
            <!-- Sección Información General -->
            <div class="info-section">
                <h3 class="section-title">Información General</h3>
                
                <div class="info-grid">
                    <div class="info-left">
                        <div class="info-item">
                            <span class="info-label">ID de la transacción:</span>
                            <span class="info-value" id="transaction-id">5155</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Tipo:</span>
                            <span class="info-value" id="transaction-type">Compra</span>
                        </div>
                    </div>
                    
                    <div class="info-center">
                        <div class="info-item">
                            <span class="info-label">Fecha de creación:</span>
                            <span class="info-value" id="creation-date">30-05-25 15:30</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Fecha de pago:</span>
                            <span class="info-value" id="payment-date">No se ha registrado pago</span>
                        </div>
                    </div>
                    
                    <div class="info-right">
                        <div class="status-box">
                            <div class="status-label">Estado:</div>
                            <div class="status-value" id="transaction-status">Pendiente</div>
                        </div>
                    </div>
                </div>
                
                <div class="section-separator"></div>
            </div>
            
            <!-- Sección Cliente y Usuario -->
            <div class="info-section">
                <h3 class="section-title">Cliente y Usuario</h3>
                
                <div class="info-grid">
                    <div class="info-left">
                        <div class="info-item">
                            <span class="info-label">Cliente:</span>
                            <span class="info-value" id="client-name">cliente1</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Documento:</span>
                            <span class="info-value" id="client-document">12345678</span>
                        </div>
                    </div>
                    
                    <div class="info-center">
                        <div class="info-item">
                            <span class="info-label">Usuario:</span>
                            <span class="info-value" id="user-name">admin</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Nombre y Apellido:</span>
                            <span class="info-value" id="user-fullname">Administrador Sistema</span>
                        </div>
                    </div>
                    
                    <div class="info-right">
                        <!-- Espacio vacío para mantener el layout -->
                    </div>
                </div>
                
                <div class="section-separator"></div>
            </div>
            
            <!-- Sección Operación de Cambio -->
            <div class="info-section">
                <h3 class="section-title">Operación de Cambio</h3>
                
                <div class="exchange-grid">
                    <div class="exchange-left">
                        <div class="exchange-item">
                            <span class="exchange-label">Moneda Origen:</span>
                            <div class="currency-info">
                                <img src="/media/currency_flags/3._Argentina_-_Peso_Argentino.png" alt="ARS" class="currency-flag">
                                <span class="exchange-value" id="origin-currency">ARS - Peso Argentino</span>
                            </div>
                        </div>
                        <div class="exchange-item">
                            <span class="exchange-label">Moneda Destino:</span>
                            <div class="currency-info">
                                <img src="/media/currency_flags/1._USA_-_Dólar_Americano.png" alt="USD" class="currency-flag">
                                <span class="exchange-value" id="dest-currency">USD - Dólar Estadounidense</span>
                            </div>
                        </div>
                        <div class="exchange-item">
                            <span class="exchange-label">Tasa de cambio:</span>
                            <span class="exchange-value" id="exchange-rate">1 USD - 544224 ARS</span>
                        </div>
                    </div>
                    
                    <div class="exchange-right">
                        <div class="exchange-item">
                            <span class="exchange-label">Monto Origen:</span>
                            <span class="exchange-value" id="origin-amount">7250 $</span>
                        </div>
                        <div class="exchange-item">
                            <span class="exchange-label">Monto Destino:</span>
                            <span class="exchange-value" id="dest-amount">15223500 $</span>
                        </div>
                    </div>
                </div>
                
                <div class="section-separator"></div>
            </div>
            
            <!-- Sección Medio de Pago y Cobro -->
            <div class="info-section">
                <h3 class="section-title">Medio de Pago y Cobro</h3>
                
                <div class="payment-grid">
                    <div class="payment-item">
                        <span class="payment-label">Medio de Pago:</span>
                        <span class="payment-value" id="payment-method">Tauser 1</span>
                    </div>
                    <div class="payment-item">
                        <span class="payment-label">Medio de Cobro:</span>
                        <span class="payment-value" id="collection-method">Tauser 2</span>
                    </div>
                </div>
                
                <div class="section-separator"></div>
            </div>
            
            <!-- Sección Facturación -->
            <div class="info-section">
                <h3 class="section-title">Facturación</h3>
                
                <div class="billing-grid">
                    <div class="billing-left">
                        <div class="billing-item">
                            <span class="billing-label">Número de factura:</span>
                            <span class="billing-value" id="invoice-number">No emitida</span>
                        </div>
                        <div class="billing-item">
                            <span class="billing-label">Fecha de emisión:</span>
                            <span class="billing-value" id="invoice-date">No emitida</span>
                        </div>
                    </div>
                    
                    <div class="billing-right">
                        <div class="billing-status-box">
                            <div class="billing-status-label">Estado:</div>
                            <div class="billing-status-value" id="invoice-status">No emitida</div>
                        </div>
                    </div>
                </div>
                
                <div class="section-separator"></div>
            </div>
            
            <!-- Sección Auditoría y Control -->
            <div class="info-section">
                <h3 class="section-title">Auditoría y Control</h3>
                
                <div class="audit-grid">
                    <div class="audit-left">
                        <div class="audit-item">
                            <span class="audit-label">Fecha de cancelación:</span>
                            <span class="audit-value" id="cancellation-date">No aplica</span>
                        </div>
                        <div class="audit-item">
                            <span class="audit-label">Motivo de cancelación:</span>
                            <span class="audit-value" id="cancellation-reason">No aplica</span>
                        </div>
                    </div>
                    
                    <div class="audit-right">
                        <div class="audit-item">
                            <span class="audit-label">Fecha de anulación:</span>
                            <span class="audit-value" id="annulment-date">No aplica</span>
                        </div>
                        <div class="audit-item">
                            <span class="audit-label">Motivo de anulación:</span>
                            <span class="audit-value" id="annulment-reason">No aplica</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal Prompt Cambio de Cotización -->
<div id="cambioCotizacionModal" class="modal-overlay" style="display:none;">
    <div class="modal-container">
        <!-- Header -->
        <div class="modal-header">
            <img src="{% static 'webapp/logo.png' %}" alt="Logo" class="modal-logo">
            <h2 class="modal-title">Actualización de cotización</h2>
        </div>

        <div class="modal-separator"></div>

        <div class="modal-content">
            <!-- Info general -->
            <div class="info-section">
                <h3 class="section-title">Información de la transacción</h3>
                <div class="info-grid">
                    <div class="info-left">
                        <div class="info-item">
                            <span class="info-label">ID de la transacción:</span>
                            <span class="info-value" id="cc-transaccion-id">—</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Moneda afectada:</span>
                            <span class="info-value" id="cc-moneda-code">—</span>
                        </div>
                    </div>
                    <div class="info-center">
                        <div class="info-item">
                            <span class="info-label">Tasa anterior:</span>
                            <span class="info-value" id="cc-tasa-anterior">—</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Tasa actual:</span>
                            <span class="info-value" id="cc-tasa-actual">—</span>
                        </div>
                    </div>
                    <div class="info-right">
                        <!-- vacío para mantener layout, si querés -->
                    </div>
                </div>

                <div class="section-separator"></div>
            </div>

            <!-- Comparación de montos -->
            <div class="info-section">
                <h3 class="section-title">Comparación de montos</h3>

                <div class="exchange-grid">
                    <!-- Montos anteriores -->
                    <div class="exchange-left">
                        <h4 class="section-subtitle">Montos anteriores</h4>

                        <div class="exchange-item">
                            <span class="exchange-label">Monto origen:</span>
                            <span class="exchange-value" id="cc-monto-origen-anterior">—</span>
                        </div>
                        <div class="exchange-item">
                            <span class="exchange-label">Monto destino:</span>
                            <span class="exchange-value" id="cc-monto-destino-anterior">—</span>
                        </div>
                    </div>

                    <!-- Montos nuevos -->
                    <div class="exchange-right">
                        <h4 class="section-subtitle">Montos nuevos</h4>

                        <div class="exchange-item">
                            <span class="exchange-label">Monto origen:</span>
                            <span class="exchange-value" id="cc-monto-origen-nuevo">—</span>
                        </div>
                        <div class="exchange-item">
                            <span class="exchange-label">Monto destino:</span>
                            <span class="exchange-value" id="cc-monto-destino-nuevo">—</span>
                        </div>
                    </div>
                </div>

                <p style="margin-top: 12px;">
                    La cotización de tu transacción ha cambiado. ¿Querés aceptar la nueva cotización
                    o cancelar la transacción?
                </p>
            </div>

            <!-- Acciones -->
            <div class="section-separator"></div>

            <div class="info-section">
                <div class="modal-actions">
                    <!-- Aceptar nueva cotización -->
                    <form id="cc-form-aceptar" method="post" action="">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{{ request.get_full_path }}">
                        <button type="submit" class="action-button primary">
                            Aceptar nueva cotización
                        </button>
                    </form>

                    <!-- Cancelar transacción -->
                    <form id="cc-form-cancelar" method="post" action="" class="modal-form-inline">
                        {% csrf_token %}
                        <input type="hidden" name="next" value="{{ request.get_full_path }}">
                        <button type="submit" class="action-button cancel-btn">
                            Cancelar transacción
                        </button>
                    </form>

                    <!-- Cerrar solo el popup -->
                    <button type="button"
                            class="action-button secondary"
                            data-close-modal="cambioCotizacionModal">
                        Cerrar
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal de confirmación de cancelación -->
<div id="cancelConfirmModal" class="modal-overlay" style="display: none;">
    <div class="modal-container">
        <div class="modal-header">
            <h2 class="modal-title">Confirmar cancelación</h2>
        </div>

        <div class="modal-separator"></div>

        <div class="modal-content">
            <p>
                ¿Estás seguro de que deseas cancelar la transacción 
                <strong>#<span id="cancel-transaccion-id"></span></strong>?
            </p>
            <p>Esta acción no se puede deshacer.</p>

            <div class="modal-actions" style="margin-top: 20px; display: flex; gap: 10px;">
                <form id="cancel-confirm-form" method="post" action="">
                    {% csrf_token %}
                    <input type="hidden" name="next" value="{{ request.get_full_path }}">
                    <button type="submit" class="action-button cancel-btn">
                        Sí, cancelar
                    </button>
                </form>

                <button type="button" class="action-button secondary" onclick="closeCancelConfirmModal()">
                    No, volver
                </button>
            </div>
        </div>
    </div>
</div>


<script>
// Search functionality
document.getElementById('searchInput').addEventListener('input', function(e) {
    const searchTerm = e.target.value.toLowerCase();
    const rows = document.querySelectorAll('.transactions-table tbody tr');
    
    rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        if (text.includes(searchTerm)) {
            row.style.display = '';
        } else {
            row.style.display = 'none';
        }
    });
});

// Action button handlers
document.querySelectorAll('.action-button').forEach(button => {
    button.addEventListener('click', function() {
        // Los que abren el modal de cancelación se manejan aparte
        if (this.classList.contains('cancel-open-btn')) {
            return;
        }
        
        const transactionId = this.getAttribute('data-transaction-id');

        let action;
        if (this.classList.contains('view-data-btn')) {
            action = 'Ver Datos';
        } else if (this.classList.contains('view-change-btn')) {
            action = 'Ver Cambios';
        }

        if (action === 'Ver Datos') {
            openTransactionModal(transactionId);
        } else if (action === 'Ver Cambios') {
            openCambioCotizacionModal(this);  // <-- nuevo modal
        } else {
            console.log(`${action} transacción ID: ${transactionId}`);
            // Aquí la lógica para Cancelar/Anular
        }
    });
});

// Modal functionality
function openTransactionModal(transactionId) {
    // Obtener los datos de la transacción desde la fila de la tabla
    const button = document.querySelector(`[data-transaction-id="${transactionId}"]`);
    const row = button.closest('tr');
    
    if (row) {
        // Extraer datos de la fila
        const transactionType = row.querySelector('.transaction-type').textContent.trim();
        const statusText = row.querySelector('.status-text').textContent.trim();
        const creationDate = row.querySelector('.creation-date').textContent.trim();
        const paymentDate = row.querySelector('.payment-date').textContent.trim();
        const clientName = row.querySelector('.client-name').textContent.trim();
        
        
        // Actualizar el modal con los datos reales
        document.getElementById('transaction-id').textContent = transactionId;
        document.getElementById('transaction-type').textContent = transactionType;
        document.getElementById('creation-date').textContent = creationDate;
        document.getElementById('payment-date').textContent = paymentDate === '-' ? 'No se ha registrado pago' : paymentDate;
        document.getElementById('transaction-status').textContent = statusText;
        
        // Actualizar datos de cliente y usuario desde los atributos de la fila
        document.getElementById('client-name').textContent = clientName;
        document.getElementById('client-document').textContent = row.getAttribute('data-client-document') || 'No disponible';
        document.getElementById('user-name').textContent = row.getAttribute('data-user-name') || 'No disponible';
        document.getElementById('user-fullname').textContent = row.getAttribute('data-user-fullname') || 'No disponible';
        
        // Actualizar datos de operación de cambio con datos reales de la base de datos
        updateExchangeDataFromDB(row);
        
        // Actualizar datos de medio de pago y cobro con datos reales
        updatePaymentDataFromDB(row);
        
        // Actualizar datos de facturación basados en el estado
        updateBillingData(transactionId, statusText);
        
        // Actualizar datos de auditoría y control basados en el estado
        updateAuditData(transactionId, statusText);
    }
    
    const modal = document.getElementById('transactionModal');
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden'; // Prevenir scroll del fondo
}

// Función para actualizar datos de operación de cambio con datos reales de la base de datos
function updateExchangeDataFromDB(row) {
    // Extraer datos reales de la fila
    const originCurrency = row.getAttribute('data-origin-currency') || 'N/A';
    const destCurrency = row.getAttribute('data-dest-currency') || 'N/A';
    const originCurrencyName = row.getAttribute('data-origin-currency-name') || 'N/A';
    const destCurrencyName = row.getAttribute('data-dest-currency-name') || 'N/A';
    const exchangeRate = row.getAttribute('data-exchange-rate') || 'N/A';
    const originAmount = row.getAttribute('data-origin-amount') || 'N/A';
    const destAmount = row.getAttribute('data-dest-amount') || 'N/A';
    
    // Construir rutas de banderas basadas en los códigos de moneda
    const originFlag = `/media/currency_flags/${originCurrency}_flag.png`;
    const destFlag = `/media/currency_flags/${destCurrency}_flag.png`;
    
    // Actualizar las imágenes de las banderas con verificación de seguridad
    const originFlagImg = document.querySelector('#origin-currency').previousElementSibling;
    const destFlagImg = document.querySelector('#dest-currency').previousElementSibling;
    
    // Función para verificar y cargar bandera de forma segura
    function loadFlagSafely(imgElement, flagPath) {
        if (!imgElement) return;
        
        // Crear una nueva imagen para verificar si existe
        const testImg = new Image();
        testImg.onload = function() {
            // Si la imagen se carga correctamente, actualizar el src
            imgElement.src = flagPath;
            imgElement.style.display = 'block';
        };
        testImg.onerror = function() {
            // Si la imagen no existe, ocultar el elemento
            imgElement.style.display = 'none';
            console.warn(`Bandera no encontrada: ${flagPath}`);
        };
        testImg.src = flagPath;
    }
    
    // Cargar banderas de forma segura
    loadFlagSafely(originFlagImg, originFlag);
    loadFlagSafely(destFlagImg, destFlag);
    
    // Actualizar los textos con datos reales
    document.getElementById('origin-currency').textContent = `${originCurrency} - ${originCurrencyName}`;
    document.getElementById('dest-currency').textContent = `${destCurrency} - ${destCurrencyName}`;
    document.getElementById('exchange-rate').textContent = `1 ${destCurrency} = ${exchangeRate} ${originCurrency}`;
    document.getElementById('origin-amount').textContent = `${originAmount} ${originCurrency}`;
    document.getElementById('dest-amount').textContent = `${destAmount} ${destCurrency}`;
}

// Función para actualizar datos de medio de pago y cobro con datos reales
function updatePaymentDataFromDB(row) {
    const paymentMethod = row.getAttribute('data-payment-method') || 'No disponible';
    const collectionMethod = row.getAttribute('data-collection-method') || 'No disponible';
    
    document.getElementById('payment-method').textContent = paymentMethod;
    document.getElementById('collection-method').textContent = collectionMethod;
}

// Función para actualizar datos de facturación
function updateBillingData(transactionId, status) {
    if (status === 'Pagada') {
        document.getElementById('invoice-number').textContent = `FAC-${transactionId.toString().padStart(4, '0')}`;
        document.getElementById('invoice-date').textContent = '08-10-25';
        document.getElementById('invoice-status').textContent = 'Emitida';
    } else {
        document.getElementById('invoice-number').textContent = 'No emitida';
        document.getElementById('invoice-date').textContent = 'No emitida';
        document.getElementById('invoice-status').textContent = 'No emitida';
    }
}

// Función para actualizar datos de auditoría y control
function updateAuditData(transactionId, status) {
    if (status === 'Cancelada') {
        document.getElementById('cancellation-date').textContent = '07-10-25';
        document.getElementById('cancellation-reason').textContent = 'Solicitud del cliente';
        document.getElementById('annulment-date').textContent = 'No aplica';
        document.getElementById('annulment-reason').textContent = 'No aplica';
    } else if (status === 'Anulada') {
        document.getElementById('cancellation-date').textContent = 'No aplica';
        document.getElementById('cancellation-reason').textContent = 'No aplica';
        document.getElementById('annulment-date').textContent = '07-10-25';
        document.getElementById('annulment-reason').textContent = 'Error en el sistema';
    } else {
        document.getElementById('cancellation-date').textContent = 'No aplica';
        document.getElementById('cancellation-reason').textContent = 'No aplica';
        document.getElementById('annulment-date').textContent = 'No aplica';
        document.getElementById('annulment-reason').textContent = 'No aplica';
    }
}

function closeTransactionModal() {
    const modal = document.getElementById('transactionModal');
    modal.style.display = 'none';
    document.body.style.overflow = 'auto'; // Restaurar scroll
}

// Cerrar modal al hacer clic en el overlay
document.getElementById('transactionModal').addEventListener('click', function(e) {
    if (e.target === this) {
        closeTransactionModal();
    }
});

// Cerrar modal con tecla Escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeTransactionModal();
    }
});

function openCambioCotizacionModal(button) {
    const transactionId = button.getAttribute('data-transaction-id');

    // Leemos los datos de comparación desde data-* del botón
    const monedaCode = button.getAttribute('data-moneda-code') || '';
    const tasaAnterior = button.getAttribute('data-tasa-anterior') || '';
    const tasaActual = button.getAttribute('data-tasa-actual') || '';

    const montoOrigenAnterior = button.getAttribute('data-monto-origen-anterior') || '';
    const montoDestinoAnterior = button.getAttribute('data-monto-destino-anterior') || '';
    const montoOrigenNuevo = button.getAttribute('data-monto-origen-nuevo') || '';
    const montoDestinoNuevo = button.getAttribute('data-monto-destino-nuevo') || '';

    const urlAceptar = button.getAttribute('data-url-aceptar') || '#';
    const urlCancelar = button.getAttribute('data-url-cancelar') || '#';

    // Inyectar datos en el modal
    document.getElementById('cc-transaccion-id').textContent = transactionId;
    document.getElementById('cc-moneda-code').textContent = monedaCode;

    document.getElementById('cc-tasa-anterior').textContent = tasaAnterior;
    document.getElementById('cc-tasa-actual').textContent = tasaActual;

    document.getElementById('cc-monto-origen-anterior').textContent = montoOrigenAnterior;
    document.getElementById('cc-monto-destino-anterior').textContent = montoDestinoAnterior;
    document.getElementById('cc-monto-origen-nuevo').textContent = montoOrigenNuevo;
    document.getElementById('cc-monto-destino-nuevo').textContent = montoDestinoNuevo;

    // Setear acciones de los formularios
    const formAceptar = document.getElementById('cc-form-aceptar');
    const formCancelar = document.getElementById('cc-form-cancelar');

    if (formAceptar) formAceptar.action = urlAceptar;
    if (formCancelar) formCancelar.action = urlCancelar;

    const nextValue = window.location.pathname + window.location.search;

    if (formAceptar) {
        formAceptar.action = urlAceptar;

        let nextInput = formAceptar.querySelector('input[name="next"]');
        if (!nextInput) {
            nextInput = document.createElement('input');
            nextInput.type = 'hidden';
            nextInput.name = 'next';
            formAceptar.appendChild(nextInput);
        }
        nextInput.value = nextValue;
    }

    if (formCancelar) {
        formCancelar.action = urlCancelar;

        let nextInputCancel = formCancelar.querySelector('input[name="next"]');
        if (!nextInputCancel) {
            nextInputCancel = document.createElement('input');
            nextInputCancel.type = 'hidden';
            nextInputCancel.name = 'next';
            formCancelar.appendChild(nextInputCancel);
        }
        nextInputCancel.value = nextValue;

        // ⚠️ Aquí viene la parte nueva: el botón del prompt abre el modal de confirmación
        const promptCancelBtn = formCancelar.querySelector('button.cancel-btn');
        if (promptCancelBtn) {
            // Que no haga submit directo
            promptCancelBtn.type = 'button';

            // Le pasamos los datos necesarios para la confirmación
            promptCancelBtn.setAttribute('data-transaction-id', transactionId);
            promptCancelBtn.setAttribute('data-url-cancelar', urlCancelar);

            // Handler: cerrar este modal y abrir el de confirmación
            promptCancelBtn.onclick = function (e) {
                e.preventDefault();

                // Ocultamos el modal de cambio de cotización
                const cambioModal = document.getElementById('cambioCotizacionModal');
                if (cambioModal) {
                    cambioModal.style.display = 'none';
                }

                // Abrimos el modal de confirmación reutilizando la función global
                openCancelConfirmModal(this);
            };
        }
    }

    // Mostrar modal
    const modal = document.getElementById('cambioCotizacionModal');
    if (modal) {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';
    }
}

function closeCambioCotizacionModal() {
    const modal = document.getElementById('cambioCotizacionModal');
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }
}

// Cerrar modal de cambios al hacer clic en el overlay
const cambioModal = document.getElementById('cambioCotizacionModal');
if (cambioModal) {
    cambioModal.addEventListener('click', function(e) {
        if (e.target === this) {
            closeCambioCotizacionModal();
        }
    });
}

// Cerrar modal de cambios con tecla Escape
document.addEventListener('keydown', function(e) {
    if (e.key === 'Escape') {
        closeCambioCotizacionModal();
    }
});

document.addEventListener('click', function(e) {
    const closeBtn = e.target.closest('[data-close-modal]');
    if (!closeBtn) return;

    const modalId = closeBtn.getAttribute('data-close-modal');
    const modal = document.getElementById(modalId);

    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';
    }
});

// ===============================
// Modal de confirmación de cancelación
// ===============================

function openCancelConfirmModal(button) {
    const transactionId = button.getAttribute('data-transaction-id');
    const urlCancelar = button.getAttribute('data-url-cancelar') || '#';

    // Mostrar el ID de la transacción en el texto del modal
    const idSpan = document.getElementById('cancel-transaccion-id');
    if (idSpan) {
        idSpan.textContent = transactionId || '';
    }

    // Configurar la acción del formulario que realmente cancela
    const form = document.getElementById('cancel-confirm-form');
    if (form) {
        form.action = urlCancelar;

        // Si quisieras actualizar el "next" dinámicamente:
        // const nextInput = form.querySelector('input[name="next"]');
        // if (nextInput) {
        //     nextInput.value = window.location.pathname + window.location.search;
        // }
    }

    // Mostrar el modal
    const modal = document.getElementById('cancelConfirmModal');
    if (modal) {
        modal.style.display = 'flex';
        document.body.style.overflow = 'hidden';  // bloquear scroll de fondo
    }
}

function closeCancelConfirmModal() {
    const modal = document.getElementById('cancelConfirmModal');
    if (modal) {
        modal.style.display = 'none';
        document.body.style.overflow = 'auto';  // restaurar scroll
    }
}

// Vincular los botones "Cancelar" de la tabla (solo cuando NO hay cambio_pendiente)
document.querySelectorAll('.cancel-open-btn').forEach(btn => {
    btn.addEventListener('click', function (e) {
        e.preventDefault();            // no navegamos ni enviamos nada todavía
        openCancelConfirmModal(this);  // abrimos el modal de confirmación
    });
});

// Cerrar el modal haciendo clic fuera del contenido ("overlay")
const cancelModal = document.getElementById('cancelConfirmModal');
if (cancelModal) {
    cancelModal.addEventListener('click', function (e) {
        if (e.target === this) {       // click directo sobre el overlay
            closeCancelConfirmModal();
        }
    });
}

// Cerrar el modal con la tecla Escape
document.addEventListener('keydown', function (e) {
    if (e.key === 'Escape') {
        closeCancelConfirmModal();
    }
});


</script>
{% endblock %}