{% extends 'webapp/base.html' %}
{% load static %}
{% load permission_tags %}
{% block title %}Modificar Rol{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'webapp/css/roles/modify_role.css' %}">
<style>
.toast-message {
    position: fixed;
    bottom: 20px;
    right: 20px;
    background: #5a21ca;
    color: white;
    padding: 8px 12px;
    border-radius: 5px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.3);
    z-index: 9999;
    opacity: 0.9;
}
@keyframes slideOut {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(100%); opacity: 0; }
}
</style>
{% endblock %}

{% block content %}
<div class="modify-role-container">
    <!-- Messages -->
    {% if messages %}
    <div class="messages-container">
        {% for message in messages %}
        <div class="alert alert-{{ message.tags }}">
            {{ message }}
        </div>
        {% endfor %}
    </div>
    {% endif %}

    <!-- Header Section -->
    <div class="modify-role-header">
        <div class="main-content">
            <a href="{% url 'manage_roles' %}" class="back-button">← Volver a administrar roles</a>
            <div class="header-content">
                <div class="header-text">
                    <h1 class="modify-role-title">Modificar Rol</h1>
                    <p class="modify-role-subtitle">Modificar datos de un rol</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
        <div class="modify-section">
            <h2 class="section-title">Modificar Rol</h2>
            <div class="modify-content">
                <!-- Role Profile -->
                <div class="role-profile-section">
                    <div class="role-icon-circle">
                        <img src="{% static 'webapp/pantalla_roles/2.Administrar_Roles.png' %}" alt="Role Icon" class="role-profile-icon">
                    </div>
                    <div class="role-name-display">{{ role.name }}</div>
                </div>

                <!-- Role Form -->
                <div class="form-section">
                    <form method="post" class="modify-form" id="modify-form">
                        {% csrf_token %}
                        <div class="form-field">
                            <label class="field-label">Nombre del Rol</label>
                            <input type="text" name="role_name" value="{{ role.name }}" class="form-input full-input">
                        </div>
                        {% if role.name != 'Administrador' %}
                        <div class="form-field">
                            <label class="field-label">Estado</label>
                            <div class="status-checkbox">
                                <input type="checkbox" name="is_active" id="is_active" {% if role.is_active %}checked{% endif %}>
                                <label for="is_active" class="checkbox-label">Activo</label>
                            </div>
                        </div>
                        {% endif %}
                    </form>
                </div>

                <!-- Permissions Management -->
                <div class="permissions-management-section">
                    <h3 class="permissions-subtitle">Arrastra para añadir o eliminar permisos</h3>
                    <div class="permissions-containers">
                        <!-- Assigned Permissions -->
                        <div class="permissions-container assigned-permissions" id="assignedPermissions">
                            <h4 class="container-title">Permisos Asignados</h4>
                            <div class="permissions-list" id="assignedPermissionsList">
                                {% for permission in role.permissions.all %}
                                <div class="permission-item draggable" draggable="true" data-permission-id="{{ permission.id }}">
                                    <span class="remove-permission" onclick="removePermissionFromRole({{ permission.id }})">×</span>
                                    <span class="permission-name">{{ permission.name|translate_permission }}</span>
                                </div>
                                {% empty %}
                                <div class="no-permissions">No hay permisos asignados</div>
                                {% endfor %}
                            </div>
                            <div class="container-actions">
                                <button type="button" class="action-btn assign-all-btn" onclick="assignAllPermissions()">Asignar todo</button>
                                <button type="button" class="action-btn remove-all-btn" onclick="removeAllPermissions()">Quitar todo</button>
                            </div>
                        </div>

                        <!-- Unassigned Permissions -->
                        <div class="permissions-container unassigned-permissions" id="unassignedPermissions">
                            <h4 class="container-title">Permisos No Asignados</h4>
                            <div class="permissions-list" id="unassignedPermissionsList">
                                {% for permission in all_permissions %}
                                    {% if permission not in role.permissions.all %}
                                    <div class="permission-item draggable" draggable="true" data-permission-id="{{ permission.id }}">
                                        <span class="permission-name">{{ permission.name|translate_permission }}</span>
                                    </div>
                                    {% endif %}
                                {% empty %}
                                <div class="no-permissions">No hay permisos disponibles</div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="action-buttons">
                    <button type="submit" form="modify-form" class="save-button">Guardar</button>
                    <a href="{% url 'manage_roles' %}" class="discard-button">Descartar</a>
                    {% if role.name != 'Administrador' %}
                    <button type="button" class="delete-button" onclick="confirmDeleteRole()">Eliminar</button>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- JavaScript -->
<script>
const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

// Helper for toast messages
function showToast(message) {
    const toast = document.createElement('div');
    toast.className = 'toast-message';
    toast.textContent = message;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 2000);
}

// === AJAX functions for permissions ===
function addPermissionToRole(permissionId) {
    fetch('{% url "modify_role" role.id %}', {
        method: 'POST',
        headers: {'X-CSRFToken': csrfToken, 'Content-Type':'application/x-www-form-urlencoded'},
        body: new URLSearchParams({'add_permission_id': permissionId})
    })
    .then(res => res.ok ? showToast('Permiso agregado') : console.error('Error agregando permiso'))
    .catch(console.error);
}

function removePermissionFromRole(permissionId) {
    fetch('{% url "modify_role" role.id %}', {
        method: 'POST',
        headers: {'X-CSRFToken': csrfToken, 'Content-Type':'application/x-www-form-urlencoded'},
        body: new URLSearchParams({'remove_permission_id': permissionId})
    })
    .then(res => res.ok ? showToast('Permiso removido') : console.error('Error removiendo permiso'))
    .catch(console.error);
}

// Assign / remove all
function assignAllPermissions() {
    document.querySelectorAll('#unassignedPermissionsList .permission-item').forEach(item => addPermissionToRole(item.dataset.permissionId));
}
function removeAllPermissions() {
    document.querySelectorAll('#assignedPermissionsList .permission-item').forEach(item => removePermissionFromRole(item.dataset.permissionId));
}

// === Drag & Drop logic ===
let draggedElement = null;
function handleDragStart() { draggedElement = this; this.style.opacity='0.5'; }
function handleDragEnd() { this.style.opacity='1'; draggedElement=null; }
function handleDragOver(e) { e.preventDefault(); }
function handleDragEnter(e) { e.preventDefault(); this.style.backgroundColor='rgba(91,21,194,0.1)'; }
function handleDragLeave() { this.style.backgroundColor=''; }
function handleDrop(e) {
    e.preventDefault();
    this.style.backgroundColor='';
    if (!draggedElement || draggedElement.parentNode === this) return;

    const permissionId = draggedElement.dataset.permissionId;
    const isAssigned = this.id === 'assignedPermissionsList';

    if (isAssigned) addPermissionToRole(permissionId);
    else removePermissionFromRole(permissionId);

    this.appendChild(draggedElement);
}

// Initialize drag and drop
document.addEventListener('DOMContentLoaded', () => {
    const items = document.querySelectorAll('.permission-item.draggable');
    items.forEach(i => {
        i.addEventListener('dragstart', handleDragStart);
        i.addEventListener('dragend', handleDragEnd);
    });
    const containers = [document.getElementById('assignedPermissionsList'), document.getElementById('unassignedPermissionsList')];
    containers.forEach(c => {
        c.addEventListener('dragover', handleDragOver);
        c.addEventListener('drop', handleDrop);
        c.addEventListener('dragenter', handleDragEnter);
        c.addEventListener('dragleave', handleDragLeave);
    });

    // Auto-hide messages
    document.querySelectorAll('.alert').forEach(alert => setTimeout(()=>alert.remove(),5000));
});

// === Delete role confirmation ===
function confirmDeleteRole() {
    if (confirm('¿Seguro que quieres eliminar este rol?')) {
        const form = document.createElement('form');
        form.method='POST';
        form.action='{% url "modify_role" role.id %}';
        form.innerHTML = `<input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
                          <input type="hidden" name="action" value="delete_role">`;
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}
