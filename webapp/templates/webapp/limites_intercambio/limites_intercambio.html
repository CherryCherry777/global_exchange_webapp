{% extends "webapp/base.html" %}
{% load static %}

{% block title %}Administrar Límites de Intercambio{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'webapp/css/limites/limites_intercambio.css' %}" />
{% endblock %}

{% block content %}
<div class="limites-container">
    <!-- Header Section -->
    <div class="limites-header">
        <a href="{% url 'landing' %}" class="back-button">← Volver al Panel</a>
        <h1 class="limites-title">Administrar Límites de Intercambio</h1>
        <p class="limites-subtitle">Administra los límites máximos por categoría y moneda</p>
    </div>

    <!-- Main Content -->
    <div class="limites-content">
        <div class="limites-list-container">
            <h2 class="limites-list-title">Límites por Categoría</h2>

            <!-- Selector de categoría + búsqueda -->
            <div class="search-container" style="display:flex; gap:12px; align-items:center; flex-wrap:wrap;">
            <select id="categoriaSelect"
                    class="search-input"
                    name="categoria_id"                   
                    hx-get="{% url 'limites_tabla_htmx' %}"
                    hx-target="#tabla-limites-wrapper"
                    hx-trigger="change"
                    hx-include="#categoriaSelect">                 
                {% for c in categorias %}
                    <option value="{{ c.id }}"
                        {% if categoria_seleccionada and c.id == categoria_seleccionada.id %}selected{% endif %}>
                        {{ c.nombre }}
                    </option>
                {% endfor %}
            </select>

                <input type="text" class="search-input" placeholder="Buscar moneda..." id="searchInput">
            </div>

            <!-- Tabla (wrapper HTMX) -->
            <div id="tabla-limites-wrapper" class="limites-table-container" style="margin-top:12px;">
                {{ tabla_html|safe }}
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/htmx.org@1.9.12"></script>
<script>
document.addEventListener('htmx:afterSettle', attachSearchFilter);
document.addEventListener('DOMContentLoaded', attachSearchFilter);

function attachSearchFilter() {
    const searchInput = document.getElementById('searchInput');
    const rows = document.querySelectorAll('.limite-row');

    if (!searchInput) return;

    function applyFilter() {
        const term = (searchInput.value || '').toLowerCase();
        rows.forEach(row => {
            const currencyName = row.getAttribute('data-currency') || '';
            row.style.display = currencyName.includes(term) ? '' : 'none';
        });
    }

    searchInput.removeEventListener('input', applyFilter);
    searchInput.addEventListener('input', applyFilter);
}
document.getElementById("categoriaSelect").addEventListener("change", function() {
    history.pushState({}, "", `?categoria_id=${this.value}`);
});
</script>
{% endblock %}
