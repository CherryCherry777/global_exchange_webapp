{% extends "webapp/base.html" %}
{% load static %}
{% load dict_extras %}

{% block title %}Editar Límites - {{ moneda.code }}{% endblock %}

{% block content %}
<h1>Editar Límites para {{ moneda.code }} - {{ moneda.name }}</h1>

<form method="post" id="limites-form">
    {% csrf_token %}
    <table border="1" cellpadding="8" cellspacing="0" style="border-collapse: collapse; width: 100%;">
        <thead>
            <tr style="background-color: #4CAF50; color: white;">
                <th>Categoría</th>
                <th>Monto Mínimo</th>
                <th>Monto Máximo</th>
            </tr>
        </thead>
        <tbody>
            {% for categoria in categorias %}
            {% with limite=limites|get_item:categoria.nombre %}
            <tr>
                <td>{{ categoria.nombre }}</td>
                <td>
                    <input type="number"
                           step="{{ "0."|add:"0"|ljust:moneda.decimales_cotizacion|add:"1" }}"
                           name="{{ categoria.nombre }}_min"
                           value="{{ limite.monto_min }}"
                           required>
                </td>
                <td>
                    <input type="number"
                           step="{{ "0."|add:"0"|ljust:moneda.decimales_cotizacion|add:"1" }}"
                           name="{{ categoria.nombre }}_max"
                           value="{{ limite.monto_max }}"
                           required>
                </td>
            </tr>
            {% endwith %}
            {% endfor %}
        </tbody>
    </table>

    <button type="submit" style="margin-top: 15px; padding: 10px 20px; background-color: #2196F3; color: white; border: none; border-radius: 4px;">
        Guardar Cambios
    </button>
</form>

<a href="{% url 'limites_list' %}" style="display: inline-block; margin-top: 15px; text-decoration: none; color: #555;">
    ← Volver a la lista
</a>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const form = document.getElementById("limites-form");

    form.addEventListener("submit", function (e) {
        let valido = true;
        let mensajes = [];

        {% for categoria in categorias %}
            let min{{ forloop.counter }} = parseFloat(form["{{ categoria.nombre }}_min"].value);
            let max{{ forloop.counter }} = parseFloat(form["{{ categoria.nombre }}_max"].value);

            if (!isNaN(min{{ forloop.counter }}) && !isNaN(max{{ forloop.counter }})) {
                if (min{{ forloop.counter }} > max{{ forloop.counter }}) {
                    valido = false;
                    mensajes.push("En la categoría '{{ categoria.nombre }}', el mínimo no puede ser mayor que el máximo.");
                }
            }
        {% endfor %}

        if (!valido) {
            e.preventDefault();
            alert(mensajes.join("\n"));
        }
    });
});
</script>
{% endblock %}
