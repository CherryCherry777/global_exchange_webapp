{% extends "webapp/base.html" %}
{% load static %}

{% block title %}Gestionar Medios de Pago - {{ cliente.nombre }}{% endblock %}

{% block content %}
<div class="admin-page-container manage-client-payment-methods-detail">
    <!-- Header moderno -->
    <div class="admin-header">
        <div class="header-content">
            <div class="header-left">
                <a href="{% url 'manage_client_payment_methods' %}" class="back-btn">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M19 12H5M12 19l-7-7 7-7"/>
                    </svg>
                    Volver a Lista de Clientes
                </a>
                <h1 class="page-title">Gestionar Medios de Pago</h1>
                <p class="page-subtitle">Cliente: {{ cliente.nombre }}</p>
            </div>
        </div>
    </div>

    <!-- Información del cliente -->
    <div class="client-info-card">
        <div class="client-avatar-large">
            <span>{{ cliente.nombre|first|upper }}</span>
        </div>
        <div class="client-details">
            <h2>{{ cliente.nombre }}</h2>
            <div class="client-meta">
                <span class="meta-item">
                    <strong>Documento:</strong> {{ cliente.documento }}
                </span>
                <span class="meta-item">
                    <strong>Tipo:</strong> {{ cliente.get_tipoCliente_display }}
                </span>
                <span class="meta-item">
                    <strong>Categoría:</strong> {{ cliente.categoria.nombre }}
                </span>
                <span class="meta-item">
                    <strong>Estado:</strong> 
                    {% if cliente.estado %}
                        <span class="status-badge active">Activo</span>
                    {% else %}
                        <span class="status-badge inactive">Inactivo</span>
                    {% endif %}
                </span>
            </div>
        </div>
    </div>


    {% if messages %}
        <div class="messages">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }}">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Tipos de medios de pago -->
    <div class="payment-types-container">
        <div class="section-header">
            <h3>Medios de Pago Disponibles</h3>
            <p>Gestiona los diferentes tipos de medios de pago para este cliente</p>
        </div>
        
        <div class="payment-types-grid">
            {% for tipo_info in tipos_con_estado %}
            <div class="payment-type-card {{ tipo_info.codigo }}">
                <div class="payment-type-header">
                    <div class="payment-type-info">
                        <h4>{{ tipo_info.nombre }}</h4>
                        <div class="payment-type-status">
                            {% if tipo_info.tiene_medios %}
                                <span class="status-badge active">{{ tipo_info.cantidad }} configurado{{ tipo_info.cantidad|pluralize }}</span>
                            {% else %}
                                <span class="status-badge inactive">No configurado</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                
                <div class="payment-type-content">
                    {% if tipo_info.tiene_medios %}
                        <!-- Mostrar medios de pago existentes -->
                        <div class="existing-payment-methods">
                            {% for medio in tipo_info.medios %}
                            <div class="payment-method-item">
                                <div class="payment-method-info">
                                    <span class="payment-name">{{ medio.nombre }}</span>
                                    <div class="payment-method-meta">
                                        <span class="payment-status">
                                            {% if medio.activo %}
                                                <span class="status-badge active">Activo</span>
                                            {% else %}
                                                <span class="status-badge inactive">Inactivo</span>
                                            {% endif %}
                                        </span>
                                        <span class="payment-date">{{ medio.fecha_creacion|date:"d/m/Y" }}</span>
                                    </div>
                                </div>
                                <div class="payment-method-actions">
                                    <form method="post" style="display: inline;">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="toggle">
                                        <input type="hidden" name="medio_pago_id" value="{{ medio.id }}">
                                        <button type="submit" class="btn btn-sm {% if medio.activo %}btn-warning{% else %}btn-success{% endif %}" 
                                                title="{% if medio.activo %}Desactivar{% else %}Activar{% endif %}">
                                            {% if medio.activo %}
                                                Desactivar
                                            {% else %}
                                                Activar
                                            {% endif %}
                                        </button>
                                    </form>
                                    <a href="#" class="btn btn-sm btn-primary" onclick="showEditPaymentMethodModal('{{ tipo_info.codigo }}', '{{ medio.id }}')">
                                        Editar
                                    </a>
                                    <form method="post" style="display: inline;" onsubmit="return confirm('¿Estás seguro de que quieres eliminar este medio de pago?')">
                                        {% csrf_token %}
                                        <input type="hidden" name="action" value="delete">
                                        <input type="hidden" name="medio_pago_id" value="{{ medio.id }}">
                                        <button type="submit" class="btn btn-sm btn-danger" title="Eliminar">
                                            Eliminar
                                        </button>
                                    </form>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        <div class="payment-type-actions">
                            <a href="#" class="btn btn-success" onclick="showAddPaymentMethodModal('{{ tipo_info.codigo }}')">
                                Agregar Otro
                            </a>
                        </div>
                    {% else %}
                        <!-- No tiene medios de pago de este tipo -->
                        <div class="no-payment-methods">
                            <div class="empty-state">
                                <h4>No configurado</h4>
                                <p>Este cliente no tiene {{ tipo_info.nombre|lower }} configurado</p>
                            </div>
                            <div class="payment-type-actions">
                                <a href="#" class="btn btn-primary" onclick="showAddPaymentMethodModal('{{ tipo_info.codigo }}')">
                                    Agregar
                                </a>
                            </div>
                        </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<script>
function showAddPaymentMethodModal(tipo) {
    const clienteId = {{ cliente.id }};
    window.location.href = `/manage-client-payment-methods/${clienteId}/add/${tipo}/`;
}

function showEditPaymentMethodModal(tipo, medioId) {
    const clienteId = {{ cliente.id }};
    window.location.href = `/manage-client-payment-methods/${clienteId}/edit/${medioId}/`;
}
</script>
{% endblock %}