{% extends "webapp/base.html" %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'webapp/home.css' %}">
{% endblock %}

{% block title %}Compra y Venta de Divisas{% endblock %}

{% block content %}
<div class="container py-4">

    <form method="post">
        {% csrf_token %}

        <!-- Select Compra/Venta -->
        <div class="converter-section">
            <div class="converter-container">
                <h2 class="converter-title">
                    <span class="yellow-text">Compra</span> <span class="white-text">venta</span>
                </h2>
                <p class="converter-subtitle">Selecciona la moneda e ingresa el monto de cotizaci√≥n</p>
                
                <div class="converter-form">
                    <!-- From Currency -->
                    <div class="converter-field">
                        <label class="field-label">Tengo esta moneda</label>
                        <div class="field-row">
                            <div class="select-wrapper">
                                <select id="simu-from" class="currency-select"></select>
                                <img src="{% static 'webapp/home/tick.png' %}" alt="dropdown" class="select-arrow">
                            </div>
                            <input id="simu-amount" type="number" step="0.01" min="0" class="amount-input">
                        </div>
                    </div>

                    <!-- To Currency -->
                    <div class="converter-field">
                        <label class="field-label">Quiero esta moneda</label>
                        <div class="field-row">
                            <div class="select-wrapper">
                                <select id="simu-to" class="currency-select"></select>
                                <img src="{% static 'webapp/home/tick.png' %}" alt="dropdown" class="select-arrow">
                            </div>
                            <input type="text" readonly class="result-input" id="simu-result-main">
                        </div>
                    </div>

                    <div class="converter-actions">
                        <button id="simu-intercambiar" type="button" class="intercambiar-button">INTERCAMBIAR</button>
                    </div>

                    <div class="converter-result">
                        <p id="simu-result-detail" class="result-detail">Ingres√° un monto para calcular</p>
                    </div>

                </div>
            </div>
        </div>

        <!-- Selector de medio de pago -->
        <div class="mb-3">
            <label for="medio_pago" class="form-label">Medio de pago</label>
            <select name="medio_pago" id="medio_pago" class="form-select" required>
                <option value="">Seleccione</option>
                {% for medio in medios_pago %}
                    <option value="{{ medio.id }}" {% if medio.id == medio_pago %}selected{% endif %}>
                        {{ medio.nombre }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <!-- Selector de cuentas asociadas al medio de pago -->
        <div class="mb-3">
            <label for="cuenta" class="form-label">Cuenta asociada</label>
            <select name="cuenta" id="cuenta" class="form-select" required>
                <option value="">Seleccione</option>
                {% for cuenta in cuentas %}
                    <option value="{{ cuenta.id }}" {% if cuenta.id == cuenta_seleccionada %}selected{% endif %}>
                        {{ cuenta.nombre }} - {{ cuenta.numero }}
                    </option>
                {% endfor %}
            </select>
        </div>

        <button type="submit" class="btn btn-primary">Procesar</button>
    </form>

    {% if resultado %}
        <div class="alert alert-success mt-4">
            <strong>Resultado:</strong> {{ resultado }}
        </div>
    {% endif %}
</div>

<script>
(async function() {
    const amount = document.getElementById("simu-amount");
    const from = document.getElementById("simu-from");
    const to = document.getElementById("simu-to");
    const intercambiar = document.getElementById("simu-intercambiar");
    const out = document.getElementById("simu-result-main");
    const detail = document.getElementById("simu-result-detail");

    let CODES = [];
    const META = Object.create(null);

    // Funci√≥n para formatear n√∫meros seg√∫n los decimales de una moneda espec√≠fica
    function nf(value, currencyCode) {
        const decimals = currencyCode === "PYG" ? 0 : (META[currencyCode]?.decimals ?? 2);
        return new Intl.NumberFormat("es-ES", {
            minimumFractionDigits: decimals,
            maximumFractionDigits: decimals
        }).format(value);
    }

    function buildOptions(selectEl, preferCode) {
        selectEl.innerHTML = "";
        CODES.forEach(code => {
            const opt = document.createElement("option");
            opt.value = code;
            const name = META[code]?.name || code;
            if (code === "USD") opt.textContent = "D√ìLAR";
            else if (code === "PYG") opt.textContent = "GUARAN√ç";
            else if (code === "EUR") opt.textContent = "EURO";
            else opt.textContent = name.toUpperCase();
            selectEl.appendChild(opt);
        });
        if (preferCode && CODES.includes(preferCode)) selectEl.value = preferCode;
        else if (CODES.length) selectEl.value = CODES[0];
    }

    function enforceDifferent(changed, other) {
        if (changed.value === other.value) {
            const target = CODES.find(c => c !== changed.value);
            if (target) other.value = target;
        }
    }

    function compute() {
        const raw = parseFloat((amount.value || "").toString().replace(",", "."));
        if (isNaN(raw) || raw <= 0) {
            out.value = "‚Äî";
            detail.textContent = "Ingres√° un monto para calcular";
            return;
        }
        const a = from.value, b = to.value;
        if (!META[a] || !META[b]) return;

        let val, rateAB;

        if (a === "PYG" && b !== "PYG") {
            // PYG ‚Üí moneda extranjera
            val = raw / META[b].venta;
            rateAB = 1 / META[b].venta;
            detail.innerHTML = `1 ${a} = ${nf(rateAB, b)} ${b}`;
        } 
        else if (a !== "PYG" && b === "PYG") {
            // Moneda extranjera ‚Üí PYG
            val = raw * META[a].compra;
            rateAB = META[a].compra;
            detail.innerHTML = `1 ${a} = ${nf(rateAB, "PYG")} ${b}`;
        } 
        else {
            // üö´ Caso no permitido (moneda ‚Üí moneda sin pasar por PYG)
            out.value = "‚Äî";
            detail.textContent = "S√≥lo se permiten conversiones con Guaran√≠es";
            return;
        }

        out.value = `${nf(val, b)} ${b}`;
    }

    function attachListeners() {
        ["input","change"].forEach(evt => {
            amount.addEventListener(evt, compute);
            from.addEventListener(evt, () => { enforceDifferent(from,to); compute(); });
            to.addEventListener(evt, () => { enforceDifferent(to,from); compute(); });
        });
        intercambiar.addEventListener("click", () => {
            const tmp = from.value; from.value = to.value; to.value = tmp;
            enforceDifferent(from,to); compute();
        });
    }

    async function boot() {
        try {
            const res = await fetch("{% url 'api_currencies' %}", { cache:"no-store" });
            const payload = await res.json();
            const items = payload.items || [];
            const byCode = {};
            items.forEach(it => { byCode[it.code] = it; });

            if (!byCode["PYG"]) byCode["PYG"] = { code:"PYG", name:"Guaran√≠", decimals:0, venta:1.0, compra:1.0 };


            CODES = Object.keys(byCode).sort((a,b)=> a==="PYG"?-1:b==="PYG"?1:a.localeCompare(b));
            CODES.forEach(code=>META[code]=byCode[code]);

            buildOptions(from,"USD");
            buildOptions(to,"PYG");
            enforceDifferent(from,to);

            attachListeners();
            compute();
        } catch(e) {
            console.error("No se pudieron cargar monedas:", e);
        }
    }

    boot();
})();
</script>
{% endblock %}


